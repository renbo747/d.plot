<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dplot.mapper.MemberHistoryMapper">
	<select id="selectMemberHistoryList" parameterType="somap" resultType="somap">
		SELECT
			  A.MHISIDX, A.USERNO, A.MHISTYPE, A.DADAMEMBERTYPE, A.MEMLVTYPE
			, FN_GET_CODENAME(D.SITEID, 'DADAMEMBERTYPE', A.DADAMEMBERTYPE) AS DADAMEMBERTYPENAME
			, FN_GET_CODENAME(D.SITEID, 'MEMLVTYPE', A.MEMLVTYPE) AS MEMLVTYPENAME
			, (CASE WHEN A.MHISTYPE = 'MHT001' THEN FN_GET_CODENAME(D.SITEID, 'DADAMEMBERTYPE', A.AFTVAL)
				 WHEN A.MHISTYPE = 'MHT002' THEN FN_GET_CODENAME(D.SITEID, 'MEMLVTYPE', A.AFTVAL)
				 ELSE A.AFTVAL END) AS AFTVAL
			, (CASE WHEN A.MHISTYPE = 'MHT001' THEN FN_GET_CODENAME(D.SITEID, 'DADAMEMBERTYPE', A.PREVAL)
				 WHEN A.MHISTYPE = 'MHT002' THEN FN_GET_CODENAME(D.SITEID, 'MEMLVTYPE', A.PREVAL)
				 ELSE A.PREVAL END) AS PREVAL
			, A.REGUSERID, A.REGDATE
			, DATE_FORMAT(A.REGDATE, '%Y-%m-%d %H:%i:%s') AS REGDATESTR
			, (CASE WHEN B.USERNO IS NOT NULL THEN '관리자' WHEN C.USERNO IS NOT NULL THEN '고객' ELSE '알수없음' END) REGTYPENAME
		FROM T_MEMBER_HISTORY A LEFT OUTER JOIN T_USER D ON A.REGUSERID = D.USERID LEFT OUTER JOIN T_ADMIN B ON D.NO = B.USERNO LEFT OUTER JOIN T_MEMBER C ON D.NO = C.USERNO
		WHERE A.USERNO = #{userno}
		AND A.MHISTYPE = #{type}
		ORDER BY A.REGDATE DESC
	</select>

	<insert id="insertMemberHistory" parameterType="somap">
		INSERT INTO T_MEMBER_HISTORY (USERNO, MHISTYPE, DADAMEMBERTYPE, MEMLVTYPE, PREVAL, AFTVAL, REGUSERID, REGDATE)
		VALUES (#{userno}, #{mhistype}, #{dadamembertype}, #{memlvtype}, #{preval}, #{aftval}, #{reguserid}, CURRENT_TIMESTAMP)
	</insert>
</mapper>
