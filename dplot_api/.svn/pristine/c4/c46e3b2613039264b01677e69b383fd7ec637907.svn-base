<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dplot.mapper.GoodsReviewMapper">

	<!-- 운영관리 리뷰 목록 조회 -->
	<select id="selectOperationReviewList" resultType="somap" parameterType="somap">
        /* GoodsReviewMapper.xml - selectOperationReviewList 운영관리 리뷰 목록 조회  */
        <![CDATA[
        SELECT 
        		@rownum:= @rownum + 1  as no
        ]]>
               ,a.*
        FROM (
                 SELECT a.reviewidx                                                       
                      , a.isbest
                      , a.isdisplay
                      , b.goodsname
        			  <![CDATA[
                      , if(LENGTH(content) > 20, concat(substring(REGEXP_REPLACE(content, '<[^>]*>|\&([^;])*;', ''),1,20),'...'), REGEXP_REPLACE(content, '<[^>]*>|\&([^;])*;', ''))   AS content
                      ]]>
                      , date_format(a.regdate, '%Y-%m-%d')                               AS regdate         -- 등록일자
                      , a.regdate AS sortregdate
                      , a.reguserid
                      , m.name as regusername
                      , a.totpoint
                      , ifnull(d.goodcnt, 0) as goodcnt
                      , ifnull(e.filecnt, 0) as filecnt
                      , ifnull(f.noticnt, 0) as noticnt
                      , date_format(str_to_date(a.beststtime, '%Y%m%d'), '%Y-%m-%d') AS beststtime      
                      , date_format(str_to_date(a.bestedtime, '%Y%m%d'), '%Y-%m-%d') AS bestedtime  
                      , beststtime as sortbeststtime
                      , bestedtime as sortbestedtime   
                 FROM t_goods_review a
                 LEFT JOIN t_goods b ON a.goodsno = b.goodsno
                 LEFT JOIN t_member m ON a.userno = m.userno
                 LEFT JOIN (
                 	SELECT reviewidx
                 		, count(*) as goodcnt
                 	FROM t_review_help
                 	GROUP BY reviewidx
                 ) d ON a.reviewidx = d.reviewidx
                 LEFT JOIN (
                 	SELECT orgidx
                 		, count(*) as filecnt
                 	FROM t_file
                 	WHERE imgtype in ('IGT072','IGT073')
                 	AND istrash = 'F'
                 	GROUP BY orgidx 
                 ) e ON a.reviewidx = e.orgidx
                 LEFT JOIN ( 
                 	SELECT reviewidx
                 		, count(*) as noticnt
                 	FROM t_review_noti
                 	GROUP BY reviewidx
                 ) f ON a.reviewidx = f.reviewidx
                 <where>
                 	AND a.istrash = 'F'
					 <if test="userno != null and userno != ''">
						 AND a.userno = #{userno}
					 </if>
					<if test="isbest != null and isbest != ''">
	                 	AND a.isbest = #{isbest}
					</if>
					<if test='isnoti == "T"'>
						<![CDATA[
                 		AND f.noticnt > 0
                 		]]>
					</if>
					<if test='isnoti == "F"'>
						AND f.noticnt is null 
					</if>
					<if test="isdisplay != null and isdisplay != ''">
                 		AND a.isdisplay = #{isdisplay}
					</if>
					<if test="isadmin == false">
						AND a.isdisplay = 'T'
						AND b.dealerno = #{dealerno}
					</if>
			        <if test="sword != null and sword != ''">
			            <choose>
			                <when test="skey == 'goodsname'">
			                    AND b.goodsname LIKE concat('%',#{sword}, '%')
			                </when>
			                <when test="skey == 'content'">
			                    AND a.content LIKE concat('%',#{sword}, '%')
			                </when>
			                <when test="skey == 'reguserid'">
			                    AND a.reguserid LIKE concat('%', #{sword}, '%')
			                </when>
			                <when test="skey == 'regusername'">
			                    AND m.name LIKE concat('%', #{sword}, '%')
			                </when>
			                <otherwise>
			                    AND (
			                    b.goodsname LIKE concat('%',#{sword}, '%')
			                    OR a.content LIKE concat('%',#{sword}, '%')
			                    <if test="isadmin == true">
			                    OR a.reguserid LIKE concat('%', #{sword}, '%')
			                    OR m.name LIKE concat('%', #{sword}, '%')
								</if>
			                    )
			                </otherwise>
			            </choose>
			        </if>
			        <choose>
			        	<when test="stype == 'beststtime'">
			        		AND date_format(str_to_date(beststtime, '%Y%m%d'), '%Y-%m-%d') BETWEEN #{startdate} AND #{enddate}
		                </when>
		                <when test="stype == 'bestedtime'">
		                    AND date_format(str_to_date(bestedtime, '%Y%m%d'), '%Y-%m-%d') BETWEEN #{startdate} AND #{enddate}
		                </when>
		                <when test="stype == 'regdate'">
		                    AND date_format(a.regdate, '%Y-%m-%d') BETWEEN #{startdate} AND #{enddate}
		                </when>
		                <otherwise>
		                    AND (
		                    	date_format(a.regdate, '%Y-%m-%d') BETWEEN #{startdate} AND #{enddate}
			                    <if test="isadmin == true">
		                    	OR date_format(str_to_date(beststtime, '%Y%m%d'), '%Y-%m-%d') BETWEEN #{startdate} AND #{enddate}
		                    	OR date_format(str_to_date(bestedtime, '%Y%m%d'), '%Y-%m-%d') BETWEEN #{startdate} AND #{enddate}
		                    	</if>
		                    )
		                </otherwise>
			        </choose>
			        
					<if test='gubuntypearr != null and gubuntypearr.size > 0'>
						AND
						<foreach index="index" collection="gubuntypearr" item="_item" open="(" close=")" separator="OR" >
							<if test='_item == "GUB001"'>
								e.filecnt = 0
								OR e.filecnt is null
							</if>
							<if test='_item == "GUB002"'>
								<![CDATA[
									e.filecnt > 0
								]]>
							</if>
						</foreach>
					</if>
			        </where>
        ) a, (SELECT @rownum := #{startpage}) temp
        <choose>
            <when test="psort == 'totpoint_desc'">
                ORDER BY isbest DESC, totpoint DESC
            </when>
            <when test="psort == 'totpoint_asc'">
                ORDER BY isbest DESC, totpoint ASC
            </when>
            <when test="psort == 'goodcnt_desc'">
                ORDER BY isbest DESC, goodcnt DESC
            </when>
            <when test="psort == 'goodcnt_asc'">
                ORDER BY isbest DESC, goodcnt ASC
            </when>
            <when test="psort == 'filecnt_desc'">
                ORDER BY isbest DESC, filecnt DESC
            </when>
            <when test="psort == 'filecnt_asc'">
                ORDER BY isbest DESC, filecnt ASC
            </when>
            <when test="psort == 'beststtime_desc'">
                ORDER BY isbest DESC, sortbeststtime DESC
            </when>
            <when test="psort == 'beststtime_asc'">
                ORDER BY isbest DESC, sortbeststtime ASC
            </when>
            <when test="psort == 'bestedtime_desc'">
                ORDER BY isbest DESC, sortbestedtime DESC
            </when>
            <when test="psort == 'bestedtime_asc'">
                ORDER BY isbest DESC, sortbestedtime ASC
            </when>
            <when test="psort == 'regdate_desc'">
                ORDER BY isbest DESC, sortregdate DESC
            </when>
            <when test="psort == 'regdate_asc'">
                ORDER BY isbest DESC, sortregdate ASC
            </when>
            <otherwise>
                ORDER BY isbest DESC, sortregdate DESC
            </otherwise>
        </choose>
        LIMIT #{startpage}, #{endpage} -- 페이징 
    </select>
    
    <!-- 운영관리 리뷰 수량 조회 -->
	<select id="selectOperationReviewCnt" resultType="somap" parameterType="somap">
        /* GoodsReviewMapper.xml - selectOperationReviewCnt 운영관리 리뷰 수량 조회  */
         SELECT count(*) as totalcnt
         FROM t_goods_review a
         LEFT JOIN t_goods b ON a.goodsno = b.goodsno
         LEFT JOIN t_member m ON a.userno = m.userno
         LEFT JOIN (
         	SELECT reviewidx
         		, count(*) as goodcnt
         	FROM t_review_help
         	GROUP BY reviewidx
         ) d ON a.reviewidx = d.reviewidx
         LEFT JOIN (
         	SELECT orgidx
         		, count(*) as filecnt
         	FROM t_file
         	WHERE imgtype in ('IGT072','IGT073')
         	GROUP BY orgidx 
         ) e ON a.reviewidx = e.orgidx
         LEFT JOIN ( 
         	SELECT reviewidx
         		, count(*) as noticnt
         	FROM t_review_noti
         	GROUP BY reviewidx
         ) f ON a.reviewidx = f.reviewidx
        <where>
        AND a.istrash = 'F'
		<if test="userno != null and userno != ''">
			AND a.userno = #{userno}
		</if>
		<if test="isbest != null and isbest != ''">
               	AND a.isbest = #{isbest}
		</if>
		<if test='isnoti == "T"'>
			<![CDATA[
            AND f.noticnt > 0
            ]]>
		</if>
		<if test='isnoti == "F"'>
			AND f.noticnt is null 
		</if>
		<if test="isdisplay != null and isdisplay != ''">
              		AND a.isdisplay = #{isdisplay}
		</if>
		<if test="isadmin == false">
					AND a.isdisplay = 'T'
					AND b.dealerno = #{dealerno}
		</if>
        <if test="sword != null and sword != ''">
            <choose>
                <when test="skey == 'goodsname'">
                    AND b.goodsname LIKE concat('%',#{sword}, '%')
                </when>
                <when test="skey == 'content'">
                    AND a.content LIKE concat('%',#{sword}, '%')
                </when>
                <when test="skey == 'reguserid'">
                    AND a.reguserid LIKE concat('%', #{sword}, '%')
                </when>
                <when test="skey == 'regusername'">
                    AND m.name LIKE concat('%', #{sword}, '%')
                </when>
                <otherwise>
                    AND (
                    b.goodsname LIKE concat('%',#{sword}, '%')
                    OR a.content LIKE concat('%',#{sword}, '%')
			        <if test="isadmin == true">
                    OR a.reguserid LIKE concat('%', #{sword}, '%')
                    OR m.name LIKE concat('%', #{sword}, '%')
                    </if>
                    )
                </otherwise>
            </choose>
        </if>
        <choose>
        	<when test="stype == 'beststtime'">
     			AND date_format(str_to_date(beststtime, '%Y%m%d'), '%Y-%m-%d') BETWEEN #{startdate} AND #{enddate}
            </when>
            <when test="stype == 'bestedtime'">
                AND date_format(str_to_date(bestedtime, '%Y%m%d'), '%Y-%m-%d') BETWEEN #{startdate} AND #{enddate}
            </when>
            <when test="stype == 'regdate'">
                AND date_format(a.regdate, '%Y-%m-%d') BETWEEN #{startdate} AND #{enddate}
            </when>
            <otherwise>
                AND (
                	date_format(a.regdate, '%Y-%m-%d') BETWEEN #{startdate} AND #{enddate}
                	<if test="isadmin == true">
                	OR date_format(str_to_date(beststtime, '%Y%m%d'), '%Y-%m-%d') BETWEEN #{startdate} AND #{enddate}
                	OR date_format(str_to_date(bestedtime, '%Y%m%d'), '%Y-%m-%d') BETWEEN #{startdate} AND #{enddate}
                	</if>
                )
            </otherwise>
        </choose>
		<if test='gubunarr != null and gubunarr.size > 0'>
			AND
			<foreach index="index" collection="gubunarr" item="_item" open="(" close=")" separator="OR" >
				<if test='_item == "GUB001"'>
					e.filecnt = 0
					OR e.filecnt is null
				</if>
				<if test='_item == "GUB002"'>
					<![CDATA[
						e.filecnt > 0
					]]>
				</if>
			</foreach>
		</if>
        </where>
    </select>
    
    
    <!-- 리뷰 엑셀 목록 조회 -->
	<select id="selectOperationReviewExcelList" resultType="HashMap" parameterType="somap">
        /* GoodsReviewMapper.xml - selectOperationReviewExcelList 리뷰 엑셀 목록 조회 -  */
        <![CDATA[
        SELECT 
        		@rownum:= @rownum + 1 as no,
        ]]>
               a.*
        FROM (
                 SELECT a.reviewidx                                                       
                      , if(a.isbest = 'T','●','-') as isbest
                      , if(a.isdisplay = 'T','●','-') as isdisplay
                      , b.goodsname
                      <![CDATA[
                      , if(LENGTH(content) > 20, concat(substring(REGEXP_REPLACE(content, '<[^>]*>|\&([^;])*;', ''),1,20),'...'), REGEXP_REPLACE(content, '<[^>]*>|\&([^;])*;', ''))   AS content
                      ]]>
                      , date_format(a.regdate, '%Y-%m-%d')                               AS regdate         -- 등록일자
                      , a.regdate AS sortregdate
                      , a.reguserid
                      , m.name as regusername
                      , a.totpoint
                      , ifnull(d.goodcnt, 0) as goodcnt
                      , ifnull(e.filecnt, 0) as filecnt
                      , ifnull(f.noticnt, 0) as noticnt
                      , ifnull(date_format(str_to_date(a.beststtime, '%Y%m%d'), '%Y-%m-%d'),'-') AS beststtime      
                      , ifnull(date_format(str_to_date(a.bestedtime, '%Y%m%d'), '%Y-%m-%d'),'-') AS bestedtime   
                      , beststtime as sortbeststtime
                      , bestedtime as sortbestedtime   
                 FROM t_goods_review a
                 LEFT JOIN t_goods b ON a.goodsno = b.goodsno
                 LEFT JOIN t_member m ON a.userno = m.userno
                 LEFT JOIN (
                 	SELECT reviewidx
                 		, count(*) as goodcnt
                 	FROM t_review_help
                 	GROUP BY reviewidx
                 ) d ON a.reviewidx = d.reviewidx
                 LEFT JOIN (
                 	SELECT orgidx
                 		, count(*) as filecnt
                 	FROM t_file
                 	WHERE imgtype in ('IGT072','IGT073')
                 	GROUP BY orgidx 
                 ) e ON a.reviewidx = e.orgidx
                 LEFT JOIN ( 
                 	SELECT reviewidx
                 		, count(*) as noticnt
                 	FROM t_review_noti
                 	GROUP BY reviewidx
                 ) f ON a.reviewidx = f.reviewidx
                 <where>
                	AND a.istrash = 'F'
					<if test="isbest != null and isbest != ''">
	                 	AND a.isbest = #{isbest}
					</if>
					<if test='isnoti == "T"'>
						<![CDATA[
                 		AND f.noticnt > 0
                 		]]>
					</if>
					<if test='isnoti == "F"'>
						AND f.noticnt is null 
					</if>
					<if test="isdisplay != null and isdisplay != ''">
                 		AND a.isdisplay = #{isdisplay}
					</if>
					<if test="isadmin == false">
						AND a.isdisplay = 'T'
						AND b.dealerno = #{dealerno}
					</if>
			        <if test="sword != null and sword != ''">
			            <choose>
			                <when test="skey == 'goodsname'">
			                    AND b.goodsname LIKE concat('%',#{sword}, '%')
			                </when>
			                <when test="skey == 'content'">
			                    AND a.content LIKE concat('%',#{sword}, '%')
			                </when>
			                <when test="skey == 'reguserid'">
			                    AND a.reguserid LIKE concat('%', #{sword}, '%')
			                </when>
			                <when test="skey == 'regusername'">
			                    AND m.name LIKE concat('%', #{sword}, '%')
			                </when>
			                <otherwise>
			                    AND (
			                    b.goodsname LIKE concat('%',#{sword}, '%')
			                    OR a.content LIKE concat('%',#{sword}, '%')
			                    <if test="isadmin == true">
			                    OR a.reguserid LIKE concat('%', #{sword}, '%')
			                    OR m.name LIKE concat('%', #{sword}, '%')
			                    </if>
			                    )
			                </otherwise>
			            </choose>
			        </if>
			        <choose>
        				<when test="stype == 'beststtime'">
			     			AND date_format(str_to_date(beststtime, '%Y%m%d'), '%Y-%m-%d') BETWEEN #{startdate} AND #{enddate}
			            </when>
			            <when test="stype == 'bestedtime'">
			                AND date_format(str_to_date(bestedtime, '%Y%m%d'), '%Y-%m-%d') BETWEEN #{startdate} AND #{enddate}
			            </when>
			            <when test="stype == 'regdate'">
			                AND date_format(a.regdate, '%Y-%m-%d') BETWEEN #{startdate} AND #{enddate}
			            </when>
			            <otherwise>
			                AND (
			                	date_format(a.regdate, '%Y-%m-%d') BETWEEN #{startdate} AND #{enddate}
			                    <if test="isadmin == true">
			                	OR date_format(str_to_date(beststtime, '%Y%m%d'), '%Y-%m-%d') BETWEEN #{startdate} AND #{enddate}
			                	OR date_format(str_to_date(bestedtime, '%Y%m%d'), '%Y-%m-%d') BETWEEN #{startdate} AND #{enddate}
			                	</if>
			                )
			            </otherwise>
			        </choose>
					<if test='gubuntypearr != null and gubuntypearr.size > 0'>
						AND
						<foreach index="index" collection="gubuntypearr" item="_item" open="(" close=")" separator="OR" >
							<if test='_item == "GUB001"'>
								e.filecnt = 0
								OR e.filecnt is null
							</if>
							<if test='_item == "GUB002"'>
								<![CDATA[
									e.filecnt > 0
								]]>
							</if>
						</foreach>
					</if>
			        </where>
        ) a, (SELECT @rownum := 0) temp
        <choose>
            <when test="psort == 'totpoint_desc'">
                ORDER BY isbest DESC, totpoint DESC
            </when>
            <when test="psort == 'totpoint_asc'">
                ORDER BY isbest DESC, totpoint ASC
            </when>
            <when test="psort == 'goodcnt_desc'">
                ORDER BY isbest DESC, goodcnt DESC
            </when>
            <when test="psort == 'goodcnt_asc'">
                ORDER BY isbest DESC, goodcnt ASC
            </when>
            <when test="psort == 'filecnt_desc'">
                ORDER BY isbest DESC, filecnt DESC
            </when>
            <when test="psort == 'filecnt_asc'">
                ORDER BY isbest DESC, filecnt ASC
            </when>
            <when test="psort == 'beststtime_desc'">
                ORDER BY isbest DESC, sortbeststtime DESC
            </when>
            <when test="psort == 'beststtime_asc'">
                ORDER BY isbest DESC, sortbeststtime ASC
            </when>
            <when test="psort == 'bestedtime_desc'">
                ORDER BY isbest DESC, sortbestedtime DESC
            </when>
            <when test="psort == 'bestedtime_asc'">
                ORDER BY isbest DESC, sortbestedtime ASC
            </when>
            <when test="psort == 'regdate_desc'">
                ORDER BY isbest DESC, sortregdate DESC
            </when>
            <when test="psort == 'regdate_asc'">
                ORDER BY isbest DESC, sortregdate ASC
            </when>
            <otherwise>
                ORDER BY isbest DESC, sortregdate DESC
            </otherwise>
        </choose>
    </select>
    
    
    <!-- 리뷰 베스트여부 수정 -->
	<update id="updateReview" parameterType="somap">
        /* GoodsReviewMapper.xml - updateReview 리뷰 베스트여부 수정   */
        UPDATE t_goods_review
        SET isbest = #{isbest}
        , moduserid = #{moduserid}
        , moddate = now()
        WHERE reviewidx in
        <foreach collection="idxlist" index="index" item="item" separator="," open="(" close=")">
            #{item}
       </foreach>
    </update>
    
    
    <!-- 리뷰 상세 조회 -->
	<select id="selectReviewDetail" resultType="somap" parameterType="somap">
        /* GoodsReviewMapper.xml - selectReviewDetail 리뷰 상세 조회  */
        SELECT 
        	a.reguserid
        	, a.userno
        	, b.name as regusername
        	, FN_GET_CODENAME(#{siteid}, 'DADAMEMBERTYPE', b.DADAMEMBERTYPE) as DADAMEMBERTYPE
        	, FN_GET_CODENAME(#{siteid}, 'MEMLVTYPE', b.memlvtype) as memlvtype
        	, if(c.disstdate is not null and c.diseddate is not null, concat(date_format(c.disstdate, '%Y-%m-%d'),' ~ ',date_format(c.diseddate, '%Y-%m-%d')), '') as disdate
        	<![CDATA[
        	, case when TIMESTAMPDIFF(YEAR,date_format(c.disstdate,'%Y-%m-%d') ,date_format(c.diseddate,'%Y-%m-%d')) > 0 THEN concat(TIMESTAMPDIFF(YEAR,date_format(c.disstdate,'%Y-%m-%d') ,date_format(c.diseddate,'%Y-%m-%d')),'년')
        	  when TIMESTAMPDIFF(MONTH,date_format(c.disstdate,'%Y-%m-%d') ,date_format(c.diseddate,'%Y-%m-%d')) > 0 THEN concat(TIMESTAMPDIFF(MONTH,date_format(c.disstdate,'%Y-%m-%d') ,date_format(c.diseddate,'%Y-%m-%d')),'개월')
        	  when TIMESTAMPDIFF(DAY,date_format(c.disstdate,'%Y-%m-%d') ,date_format(c.diseddate,'%Y-%m-%d')) > 0 THEN concat(TIMESTAMPDIFF(DAY,date_format(c.disstdate,'%Y-%m-%d') ,date_format(c.diseddate,'%Y-%m-%d')),'일')
        	  ELSE '' END AS disdaterange
        	]]>
        	, a.goodsno
        	, c.goodscode
        	, date_format(a.moddate,'%Y-%m-%d') as moddate
        	, date_format(a.regdate,'%Y-%m-%d') as regdate
        	, a.totpoint
        	, a.isbest
      		, a.isdisplay
      		, if(a.isnoti = 'T', 'Y', 'N') as isnoti
      		, a.content
      		, ifnull(d.goodcnt, 0) as goodcnt
      		, ifnull(a.beststtime, '') as beststtime
      		, ifnull(a.bestedtime, '') as bestedtime
      		, ordgdidx
      		, orderidx
        FROM t_goods_review a
        LEFT JOIN t_member b ON a.userno = b.userno
        LEFT JOIN t_goods c ON a.goodsno = c.goodsno
        LEFT JOIN (
        	SELECT reviewidx
        		, count(*) as goodcnt
        	FROM t_review_help
        	GROUP BY reviewidx
        ) d ON a.reviewidx = d.reviewidx
        <where>
        	AND a.siteid = #{siteid}
        	AND a.reviewidx = #{reviewidx}
        </where>
    </select>
    
    <!-- 리뷰 수정 -->
	<update id="modifyReview" parameterType="somap">
        /* GoodsReviewMapper.xml - modifyReview 리뷰  수정   */
        UPDATE t_goods_review
        SET isbest = #{isbest}
        , isdisplay = #{isdisplay}
        , moduserid = #{moduserid}
        , beststtime = #{beststtime}
        , bestedtime = #{bestedtime}
        , moddate = now()
        WHERE reviewidx = #{reviewidx}
    </update>
    
    <!-- 베스트 리뷰 체크 -->
    <select id="selectBestCnt" resultType="Integer" parameterType="somap">
        /* GoodsReviewMapper.xml - modifyReview 리뷰  수정   */
        SELECT count(*)
        FROM t_goods_review a
        <where>
        	AND siteid = #{siteid}
        	<choose>
        		<when test="maxcheck != null and maxcheck != ''">
        			AND (
        				beststtime between #{beststtime} and #{bestedtime}
        				OR bestedtime between #{beststtime} and #{bestedtime}
        				<![CDATA[		
	        			OR (beststtime <= #{beststtime} and bestedtime >= #{bestedtime})
	        			]]>
        			)
        		</when>
        		<otherwise>
        			AND date_format(now(),'%Y%m%d%H%i') between beststtime and bestedtime
        		</otherwise>
        	</choose>
        	AND reviewidx != #{reviewidx}
        	AND isbest = 'T'
        	AND isdisplay = 'T'
        	AND istrash = 'F'
        </where>
    </select>
    
    
    <select id="selectReviewListbyGoodsno" parameterType="somap" resultType="somap">
    	/*GoodsReviewMapper.xml - selectReviewListbyGoodsno::상품번호로 리뷰목록 조회*/
       SELECT A.*
       FROM(
			SELECT  
			        tgr.REVIEWIDX    
			      , tgr.GOODSNO
			      , tg.goodscode
			      , FN_GET_FILE_URL(tcg.goodsno, 'FLT001', #{imgtype}) AS FULLPATH
#			      , CASE WHEN tcg.ISADDGOODS = 'T' THEN tg2.GOODSNAME
#					ELSE tg.GOODSNAME
#					END AS GOODSNAME 
#				  , CASE WHEN tcg.ISADDGOODS  = 'T' THEN FN_GET_OPTION_CONCAT(tg2.goodsno, tgod2.optioncode, ',')
#				       ELSE FN_GET_OPTION_CONCAT(tg.goodsno, tgod.optioncode, ',') 
#				       END AS OPTIONNM
				  , tg.GOODSNAME
				  , FN_GET_OPTION_CONCAT(tg.goodsno, tgod.optioncode, ',') AS OPTIONNM
			      , tgr.USERNO        
			      , tgr.CONTENT      
			      , tgr.TOTPOINT    
			      , tgr.ISBEST    
			      , tgr.ISNOTI
			      , tgr.REGUSERID
			      , DATE_FORMAT(tgr.REGDATE, '%Y-%m-%d') AS REGDATE    -- 리류등록일
			      , date_format(tgr.REGDATE,'%Y%m%d%H%i') AS REGDATEFULL -- 리뷰등록일풀
			      , tgr.REGDATE AS ORGREGDATE  -- 원래 리뷰 등록일
			      , tgr.ORDERIDX
			      , tgr.ORDGDIDX
			      , tgr.ISDISPLAY
			      , tgr.BESTSTTIME
			      , tgr.BESTEDTIME
			      , ifnull(trn.noticnt,0) AS noticnt
			      , ifnull(trh.goodcnt,0) AS goodcnt
				  , tgr2.totalpoint
		          , tgr2.totalcnt
		          , round((tgr2.totalpoint / tgr2.totalcnt),1) AS reviewavg -- 리뷰단품평균
		          , if((SELECT COUNT(*)
					FROM t_file tf
					WHERE ORGIDX = tgr.REVIEWIDX 
					AND IMGTYPE IN ('IGT072','IGT073')
					AND ISTRASH  = 'F') > 0,'T','F') AS ISFILE
				  , if((
				     	SELECT COUNT(*)
						FROM t_review_help
						WHERE REVIEWIDX  = tgr.reviewidx
						AND USERNO = #{userno}
				     )> 0,  'T' , 'F') AS ismyhelp
				  , if(#{userno}= tgr.userno, 'T', 'F') as ismyreview
				  , IF(date_format(NOW(), '%Y%m%d%H%i') <![CDATA[>=]]> date_format(date_add(tgr.regdate, INTERVAL +3 day) , '%Y%m%d%H%i') , 'T', 'F') AS isdeadline
			FROM t_goods_review tgr
			INNER JOIN t_comorder_goods tcg  ON tgr.ORDGDIDX  = tcg.ORDGDIDX
				AND tcg.ISTRASH  = 'F'
			INNER JOIN t_goods tg ON tcg.GOODSNO  = tg.GOODSNO
			INNER JOIN t_goods_option_detail tgod ON tcg.GOODSNO  = tgod.GOODSNO 
				AND tcg.OPTIONCODE  = tgod.OPTIONCODE
#			LEFT JOIN t_goods tg2 ON tcg.ORGGOODSNO = tg2.GOODSNO
#			LEFT JOIN t_goods_option_detail tgod2 ON tcg.ORGGOODSNO  = tgod2.GOODSNO 
#				AND tcg.OPTIONCODE  = tgod2.OPTIONCODE
			LEFT OUTER JOIN (
	                    SELECT goodscode
	                        , SUM(TOTPOINT) AS totalpoint
	                        , count(goodscode) AS totalcnt 
	                    FROM (
	                    	SELECT 
	                    		if(b.goodscode = #{goodscode}, b.goodscode, #{goodscode}) as goodscode 
                                , totpoint
                                , a.siteid
                                , a.istrash
	                    	FROM t_goods_review a
	                    	LEFT JOIN t_goods b ON a.goodsno = b.goodsno
			                WHERE (b.goodscode IN (
								SELECT if(b.subgoodsno IS NULL, a.goodscode, c.goodscode) as goodscode
								FROM (
									SELECT goodsno
										, goodscode
									FROM t_goods
									WHERE goodscode = #{goodscode}
								) a
								LEFT JOIN t_goods_grp b ON a.goodsno = b.maingoodsno
								LEFT JOIN t_goods c ON b.subgoodsno = c.goodsno
							)
		                    OR b.goodscode = #{goodscode}
		                   )
	                    ) a
	                    WHERE SITEID = #{siteid}
	                    AND ISTRASH  = 'F'
	                    GROUP  BY goodscode 
	                 ) tgr2 ON tg.GOODSCODE = tgr2.goodscode
			LEFT OUTER JOIN ( 
			                 	SELECT reviewidx
			                 		, count(*) as noticnt
			                 	FROM t_review_noti
			                 	GROUP BY reviewidx
			                ) trn ON tgr.reviewidx = trn.reviewidx
			LEFT OUTER JOIN (
			                 	SELECT reviewidx
			                 		, count(*) as goodcnt
			                 	FROM t_review_help
			                 	GROUP BY reviewidx
			                 ) trh ON tgr.reviewidx = trh.reviewidx
			WHERE  1 = 1
			AND tgr.ISTRASH = 'F'
			AND tgr.SITEID  = #{siteid}
			AND tg.ISOPENREVIEW = 'T'
			<choose>
				<when test='isdetail == "T"'>
					AND (
						tg.goodscode IN (
							SELECT if(b.subgoodsno IS NULL, a.goodscode, c.goodscode) as goodscode
							FROM (
								SELECT goodsno
									, goodscode
								FROM t_goods
								WHERE goodscode = #{goodscode}
							) a
							LEFT JOIN t_goods_grp b ON a.goodsno = b.maingoodsno
							LEFT JOIN t_goods c ON b.subgoodsno = c.goodsno
						)
						OR tg.goodscode = #{goodscode}
					)
				</when>
				<otherwise>
					<choose>
						<when test='goodsno != null and goodsno !=""'>
						and tgr.goodsno = #{goodsno}
						</when>
						<when test='goodscode != null and goodscode !=""'>
						and tg.goodscode = #{goodscode}
						</when>
					</choose>
				</otherwise>
			</choose>
			<if test='isbest != null and isbest != ""'>
			AND tgr.ISBEST = #{isbest}
			AND date_format(now(), '%Y%m%d%H%i') BETWEEN tgr.beststtime AND tgr.bestedtime
			</if>
		  ) A
	   WHERE  1= 1
	   <choose>
		   <when test='issearch == "T"'>
		   	 <if test='isfile != null and isfile != "" and isfile != "reviewall"'>
		   	 AND ISFILE = #{isfile}
		   	 </if>
		   	 <if test='point != null and point != ""'>
		   	 AND TOTPOINT <![CDATA[>=]]> #{point}
		   	 </if>
			 <choose>
			 	<when test='order == "goodcnt"'>
			   	 ORDER BY goodcnt DESC
			   	</when>
			   	<when test='order == "new"'>
			   	 ORDER BY regdate DESC
			   	</when>
			   	<when test='order == "pointtop"'>
			   	 ORDER BY totpoint DESC
			   	</when>
			   	<when test='order == "pointlow"'>
			   	 ORDER BY totpoint ASC
			   	</when>
			   	<otherwise>
			   	 ORDER BY regdate DESC
			   	</otherwise>
		   	 </choose>
		   </when>
		   <otherwise>
		   ORDER BY regdate DESC
		   </otherwise>
	   </choose>
	   <if test='isnopaging != "T"'>
		LIMIT #{startpage}, #{endpage}
	   </if>
    </select>
    
    <select id="selectReviewListbyGoodsnoCnt" parameterType="somap" resultType="int">
    /*GoodsReviewMapper.xml - selectReviewListbyGoodsnoCnt::상품번호로 리뷰목록수 조회*/
       SELECT count(*)
       FROM(
			SELECT  
			        tgr.REVIEWIDX    
			      , tgr.GOODSNO
			      , tgr.USERNO        
			      , tgr.CONTENT      
			      , tgr.TOTPOINT    
			      , tgr.ISBEST    
			      , tgr.ISNOTI
			      , tgr.REGUSERID
			      , DATE_FORMAT(tgr.REGDATE, '%Y-%m-%d') AS REGDATE    -- 리류등록일
			      , date_format(tgr.REGDATE,'%Y%m%d%H%i') AS REGDATEFULL -- 리뷰등록일풀
			      , tgr.REGDATE AS ORGREGDATE  -- 원래 리뷰 등록일
			      , tgr.ORDERIDX
			      , tgr.ORDGDIDX
			      , tgr.ISDISPLAY
			      , tgr.BESTSTTIME
			      , tgr.BESTEDTIME
			      , ifnull(trn.noticnt,0) AS noticnt
			      , ifnull(trh.goodcnt,0) AS goodcnt
				  , tgr2.totalpoint
		          , tgr2.totalcnt
		          , truncate((tgr2.totalpoint / tgr2.totalcnt),1) AS reviewavg -- 리뷰단품평균
		          , if((SELECT COUNT(*)
					FROM t_file tf
					WHERE ORGIDX = tgr.REVIEWIDX 
					AND IMGTYPE IN ('IGT072','IGT073')
					AND ISTRASH  = 'F') > 0,'T','F') AS ISFILE
			FROM t_goods_review tgr
			INNER JOIN t_comorder_goods tcg  ON tgr.ORDGDIDX  = tcg.ORDGDIDX
				AND tcg.ISTRASH  = 'F'
			INNER JOIN t_goods tg ON tcg.GOODSNO  = tg.GOODSNO
			INNER JOIN t_goods_option_detail tgod ON tcg.GOODSNO  = tgod.GOODSNO 
				AND tcg.OPTIONCODE  = tgod.OPTIONCODE
			LEFT JOIN t_goods tg2 ON tcg.ORGGOODSNO = tg2.GOODSNO
			LEFT JOIN t_goods_option_detail tgod2 ON tcg.ORGGOODSNO  = tgod2.GOODSNO 
				AND tcg.OPTIONCODE  = tgod2.OPTIONCODE
			LEFT OUTER JOIN (
	                    SELECT goodsno
	                        , SUM(TOTPOINT) AS totalpoint
	                        , count(goodsno) AS totalcnt 
	                    FROM t_goods_review
	                    WHERE SITEID = #{siteid}
	                    AND ISTRASH  = 'F'
	                    GROUP  BY goodsno 
	                 ) tgr2 ON tgr.GOODSNO = tgr2.goodsno
			LEFT OUTER JOIN ( 
			                 	SELECT reviewidx
			                 		, count(*) as noticnt
			                 	FROM t_review_noti
			                 	GROUP BY reviewidx
			                ) trn ON tgr.reviewidx = trn.reviewidx
			LEFT OUTER JOIN (
			                 	SELECT reviewidx
			                 		, count(*) as goodcnt
			                 	FROM t_review_help
			                 	GROUP BY reviewidx
			                 ) trh ON tgr.reviewidx = trh.reviewidx
			WHERE  1 = 1
			AND tgr.ISTRASH = 'F'
			AND tgr.SITEID  = #{siteid}
			<choose>
				<when test='isdetail == "T"'>
					AND (
						tg.goodscode IN (
							SELECT if(b.subgoodsno IS NULL, a.goodscode, c.goodscode) as goodscode
							FROM (
								SELECT goodsno
									, goodscode
								FROM t_goods
								WHERE goodscode = #{goodscode}
							) a
							LEFT JOIN t_goods_grp b ON a.goodsno = b.maingoodsno
							LEFT JOIN t_goods c ON b.subgoodsno = c.goodsno
						)
						OR tg.goodscode = #{goodscode}
					)
				</when>
				<otherwise>
					<choose>
						<when test='goodsno != null and goodsno !=""'>
						and tgr.goodsno = #{goodsno}
						</when>
						<when test='goodscode != null and goodscode !=""'>
						and tg.goodscode = #{goodscode}
						</when>
					</choose>
				</otherwise>
			</choose>
			<if test='isbest != null and isbest != ""'>
			AND tgr.ISBEST = #{isbest}
			AND date_format(now(), '%Y%m%d%H%i') BETWEEN tgr.beststtime AND tgr.bestedtime
			</if>
		  ) A
	   WHERE  1= 1
	   <choose>
		   <when test='issearch == "T"'>
		   	 <if test='isfile != null and isfile != "" and isfile != "reviewall"'>
		   	 AND ISFILE = #{isfile}
		   	 </if>
		   	 <if test='point != null and point != ""'>
		   	 AND TOTPOINT <![CDATA[>=]]> #{point}
		   	 </if>
			 <choose>
			 	<when test='order == "goodcnt"'>
			   	 ORDER BY goodcnt DESC
			   	</when>
			   	<when test='order == "new"'>
			   	 ORDER BY regdate DESC
			   	</when>
			   	<when test='order == "pointtop"'>
			   	 ORDER BY totpoint DESC
			   	</when>
			   	<when test='order == "pointlow"'>
			   	 ORDER BY totpoint ASC
			   	</when>
			   	<otherwise>
			   	 ORDER BY regdate DESC
			   	</otherwise>
		   	 </choose>
		   </when>
		   <otherwise>
		   ORDER BY regdate DESC
		   </otherwise>
	   </choose>
    </select>
    
    
    <select id="selectMyReviewList" parameterType="somap" resultType="somap">
		SELECT /*GoodsReviewMapper.xml - selectMyReviewList:: 나의 리뷰 목록 조회*/
		       DATE_FORMAT(A.ORDERDATE, '%Y.%m.%d') AS ORDERDATE-- 주문일자
		     , COUNT(*) OVER() as totcnt
		     , A.ORDERIDX   /* 주문idx */
		     , A.ORDGDIDX   /* 주문상품idx */
		     , A.ORDCNT     /* 주문수량 */
		     , A.GOODSNO    /* 상품번호 */
		     , A.GOODSCODE
		     , A.GOODSNAME  /* 상품명 */
		     , A.OPTIONNM   /* 옵션명  */
		     , A.FULLPATH   /* 이미지파일경로 */
		     , A.ISREVIEW   /* 리뷰작성여부 */
		     , A.ISADDGOODS /* 추가상품여부 */
		     , A.REVIEWIDX  /* 리뷰IDX */
		     , DATE_FORMAT(A.REGDATE, '%Y.%m.%d') AS REGDATE    /* 리류등록일 */
		     , date_format(A.REGDATE,'%Y%m%d%H%i') AS REGDATEFULL /* 리뷰등록일풀 */
		     , A.REGDATE AS ORGREGDATE  /* 원래 리뷰 등록일 */
		     , A.TOTPOINT   /* 리뷰점수 */
		     , A.ISBEST     /* 베스트리뷰 여부  */
		     , A.CONTENT    /* 리뷰 내용 */
		     , A.totalpoint /* 총점 */
		     , A.totalcnt   /* 리뷰수 */
		     , A.noticnt    /* 신고수 */
			 , A.goodcnt    /* 좋아요수 */
		     , truncate((A.totalpoint / A.totalcnt),1) AS reviewavg /* 리뷰단품평균 */
		     , A.brandname  /* 브랜드명 */
		     , A.ORDSTATUS
		     , A.isdeadline
		     , IF((a.revicnt >  0) , 'T', 'F') as isdelyn
		FROM (
				SELECT tc.ORDERDATE
				     , tcg.ORDERIDX
				     , tcg.ORDGDIDX 
				     , tcg.FRSTORDCNT as ordcnt
				     , tg.GOODSNO
				     , tg.GOODSCODE
 				     <!--, CASE WHEN tcg.ISADDGOODS = 'T' THEN tg2.GOODSNAME
				       ELSE tg.GOODSNAME
				       END AS GOODSNAME 
				     , CASE WHEN tcg.ISADDGOODS  = 'T' THEN FN_GET_OPTION_CONCAT(tg2.goodsno, tgod2.optioncode, ',')
				       ELSE FN_GET_OPTION_CONCAT(tg.goodsno, tgod.optioncode, ',') 
				       END AS OPTIONNM -->
					 , tg.GOODSNAME
					 , FN_GET_OPTION_CONCAT(tg.goodsno, tgod.optioncode, ',') AS OPTIONNM
				     , FN_GET_FILE_URL(tcg.goodsno, 'FLT001', #{imgtype}) AS FULLPATH
				     , IF(tgr.REVIEWIDX IS NOT NULL, 'T', 'F') AS ISREVIEW
				     , tcg.ISADDGOODS
				     , tgr.reviewidx
				     , tgr.regdate
				     , tgr.TOTPOINT
				     , tgr.ISBEST
				     , tgr.CONTENT
				     , tgr2.totalpoint
				     , tgr2.totalcnt
				     , trn.noticnt
				     , trh.goodcnt
					 , (select enname 
					   from t_brand 
					   where idx = tg.brandidx 
					   and istrash = 'F' 
					   and siteid = #{siteid}
					   ) as brandname /* 브랜드명 */
					 , FN_GET_ORDER_STATUS(tcg.ORDGDIDX) AS ORDSTATUS
					 , IF(date_format(NOW(), '%Y%m%d%H%i') <![CDATA[>=]]> date_format(date_add(tgr.regdate, INTERVAL +3 day) , '%Y%m%d%H%i') , 'T', 'F') AS isdeadline
					 , (SELECT COUNT(*) FROM t_goods_review WHERE orderidx = tc.orderidx AND GOODSNO = TCG.GOODSNO AND userno = tc.userno) AS revicnt
				FROM t_comorder tc 
				INNER JOIN t_comorder_goods tcg ON tc.ORDERIDX  = tcg.ORDERIDX
					AND tcg.ISTRASH  = 'F'
				INNER JOIN t_goods tg ON tcg.GOODSNO  = tg.GOODSNO  /* 본상품 */
				INNER JOIN t_goods_option_detail tgod ON tcg.GOODSNO  = tgod.GOODSNO 
					AND tcg.OPTIONCODE  = tgod.OPTIONCODE
				<!--LEFT JOIN t_goods tg2 ON tcg.ORGGOODSNO = tg2.GOODSNO /* 추가상품 */
				LEFT JOIN t_goods_option_detail tgod2 ON tcg.ORGGOODSNO  = tgod2.GOODSNO 
					AND tcg.OPTIONCODE  = tgod2.OPTIONCODE-->
				LEFT JOIN t_goods_review tgr ON tgr.ORDERIDX  = tcg.ORDERIDX
					AND tgr.ORDGDIDX  = tcg.ORDGDIDX
					AND tgr.ISTRASH  = 'F'
					AND tgr.SITEID = #{siteid}
				LEFT OUTER JOIN (
	                    SELECT goodsno
	                        , SUM(TOTPOINT) AS totalpoint
	                        , count(goodsno) AS totalcnt 
	                    FROM t_goods_review
	                    WHERE SITEID = #{siteid}
	                    AND ISTRASH  = 'F'
	                    GROUP  BY goodsno 
	                 ) tgr2 ON tgr.GOODSNO = tgr2.goodsno
			    LEFT OUTER JOIN ( 
			           SELECT reviewidx
			                , count(*) as noticnt
			           FROM t_review_noti
			           GROUP BY reviewidx
			        ) trn ON tgr.reviewidx = trn.reviewidx
			   LEFT OUTER JOIN (
			           SELECT reviewidx
			                 , count(*) as goodcnt
			           FROM t_review_help
			           GROUP BY reviewidx
			       ) trh ON tgr.reviewidx = trh.reviewidx
			WHERE 1 = 1
			AND tc.ISTRASH  = 'F'
			AND tc.USERNO  = #{userno}
		) A 
		WHERE 1 = 1
		AND A.ORDSTATUS = 'ODS009'
		<if test='isreview == "F"'>
			AND A.revicnt = 0
		</if>
		<if test="isreview != null and isreview != ''">
			AND A.ISREVIEW = #{isreview}
		</if>
		<if test="goodsno != null and goodsno != ''">
		    AND A.GOODSNO = #{goodsno}
		</if>
		<if test="goodscode != null and goodscode != ''">
			AND A.GOODSCODE = #{goodscode}
		</if>
		ORDER BY A.REGDATE DESC, A.ORDERDATE DESC
		
		<if test='isnopaging != "T"'>
			<if test='startpage!= null and !startpage.equals("") and endpage!=null and !endpage.equals("")'>
				LIMIT #{startpage}, #{endpage}
			</if>
			<if test='limit != null and !limit.equals("")'>
				LIMIT #{limit}
			</if>
		</if>
    </select>
    
    <select id="selectMyReviewCnt" parameterType="somap" resultType="int">
        SELECT /*GoodsReviewMapper.xml - selectMyReviewCnt:: 나의 리뷰 목록  전체 수 조회*/
		       COUNT(*)  as listtotal 
		FROM (
				SELECT tc.ORDERDATE
				     , tcg.ORDERIDX
				     , tcg.ORDGDIDX 
				     , tg.GOODSNO
				     , tg.GOODSCODE
				     , FN_GET_ORDER_STATUS(tcg.ORDGDIDX) AS ORDSTATUS
				     , IF(tgr.REVIEWIDX IS NOT NULL, 'T', 'F') AS ISREVIEW
				      , (SELECT COUNT(*) FROM t_goods_review WHERE orderidx = tc.orderidx AND userno = tc.userno) AS revicnt
				FROM t_comorder tc 
				INNER JOIN t_comorder_goods tcg ON tc.ORDERIDX  = tcg.ORDERIDX
					AND tcg.ISTRASH  = 'F'
				INNER JOIN t_goods tg ON tcg.GOODSNO  = tg.GOODSNO
				INNER JOIN t_goods_option_detail tgod ON tcg.GOODSNO  = tgod.GOODSNO 
					AND tcg.OPTIONCODE  = tgod.OPTIONCODE
				LEFT JOIN t_goods tg2 ON tcg.ORGGOODSNO = tg2.GOODSNO
				LEFT JOIN t_goods_option_detail tgod2 ON tcg.ORGGOODSNO  = tgod2.GOODSNO 
					AND tcg.OPTIONCODE  = tgod2.OPTIONCODE
				LEFT JOIN t_goods_review tgr ON tgr.ORDERIDX  = tcg.ORDERIDX
					AND tgr.ORDGDIDX  = tcg.ORDGDIDX
					AND tgr.ISTRASH  = 'F'
					AND tgr.SITEID = #{siteid}
			WHERE 1 = 1
			AND tc.ISTRASH  = 'F'
			AND tc.USERNO  = #{userno}
		) A 
		WHERE 1 = 1
		AND A.ORDSTATUS = 'ODS009'
		<if test='isreview == "F"'>
			AND A.revicnt = 0
		</if>
		<if test="isreview != null and isreview != ''">
			AND A.ISREVIEW = #{isreview}
		</if>
		<if test="goodsno != null and goodsno != ''">
			AND A.GOODSNO = #{goodsno}
		</if>
		<if test="goodscode != null and goodscode != ''">
			AND A.GOODSCODE = #{goodscode}
		</if>
		ORDER BY A.ORDERDATE DESC
    </select>
    
    <select id="selectFrontReviewDetail" parameterType="somap" resultType="somap">
    SELECT /*GoodsReviewMapper.xml - selectMyReviewDetail:: 나의 리뷰 상세 조회*/
		       DATE_FORMAT(A.ORDERDATE, '%Y.%m.%d') AS ORDERDATE-- 주문일자
		     , A.ORDERIDX   -- 주문idx
		     , A.ORDGDIDX   -- 주문상품idx
		     , A.ORDCNT     -- 주문수량
		     , A.GOODSNO    -- 상품번호
		     , a.goodscode
		     , A.GOODSNAME  -- 상품명
		     , A.OPTIONNM   -- 옵션명 
		     , A.FULLPATH   -- 이미지파일경로
		     , A.ISREVIEW   -- 리뷰작성여부
		     , A.ISADDGOODS -- 추가상품여부
		     , A.REVIEWIDX  -- 리뷰idx
		     , DATE_FORMAT(A.REGDATE, '%Y.%m.%d') AS REGDATE -- 리뷰등록일자
		     , A.REGUSERID  -- 등록자ID
		     , A.TOTPOINT   -- 리뷰점수
		     , A.ISBEST     -- 베스트리뷰 여부 
		     , A.CONTENT    -- 리뷰 내용
		     , A.totalpoint -- 총점
		     , A.totalcnt   -- 리뷰수
		     , A.noticnt    -- 신고수
			 , A.goodcnt    -- 좋아요수
		     , truncate((A.totalpoint / A.totalcnt),1) AS reviewavg -- 리뷰단품평균
		     , A.brandname  -- 브랜드명
		     , A.ismyhelp   -- 리뷰 좋아요여부 
		     , ORDSTATUS
		     , isdeadline
		FROM (
				SELECT tc.ORDERDATE
				     , tcg.ORDERIDX
				     , tcg.ORDGDIDX 
				     , tcg.FRSTORDCNT AS ORDCNT
				     , tg.GOODSNO
				     , tg.goodscode
#				     , CASE WHEN tcg.ISADDGOODS = 'T' THEN tg2.GOODSNAME
#				       ELSE tg.GOODSNAME
#				       END AS GOODSNAME 
#				     , CASE WHEN tcg.ISADDGOODS  = 'T' THEN FN_GET_OPTION_CONCAT(tg2.goodsno, tgod2.optioncode, ',')
#				       ELSE FN_GET_OPTION_CONCAT(tg.goodsno, tgod.optioncode, ',') 
#				       END AS OPTIONNM
					 , tg.GOODSNAME
					 , FN_GET_OPTION_CONCAT(tg.goodsno, tgod.optioncode, ',') AS OPTIONNM
				     , FN_GET_FILE_URL(tcg.goodsno, 'FLT001', #{imgtype}) AS FULLPATH
				     , IF(tgr.REVIEWIDX IS NOT NULL, 'T', 'F') AS ISREVIEW
				     , tcg.ISADDGOODS
				     , tgr.REVIEWIDX
				     , tgr.REGDATE
				     , tgr.REGUSERID
				     , tgr.TOTPOINT
				     , tgr.ISBEST
				     , tgr.CONTENT
				     , tgr2.totalpoint
				     , tgr2.totalcnt
				     , trn.noticnt
				     , trh.goodcnt
				     , (select enname 
					   from t_brand 
					   where idx = tg.brandidx 
					   and istrash = 'F' 
					   and siteid = #{siteid}
					   ) as brandname -- 브랜드명
					 , if((
				     	SELECT COUNT(*)
						FROM t_review_help
						WHERE REVIEWIDX  = #{reviewidx}
						AND USERNO = #{userno}
				       )> 0,  'T' , 'F') AS ismyhelp
				     , FN_GET_ORDER_STATUS(tcg.ORDGDIDX) AS ORDSTATUS
				     , IF(date_format(NOW(), '%Y%m%d%H%i') <![CDATA[>=]]> date_format(date_add(tgr.regdate, INTERVAL +3 day) , '%Y%m%d%H%i') , 'T', 'F') AS isdeadline
				FROM t_comorder tc 
				INNER JOIN t_comorder_goods tcg ON tc.ORDERIDX  = tcg.ORDERIDX
					AND tcg.ISTRASH  = 'F'
				INNER JOIN t_goods tg ON tcg.GOODSNO  = tg.GOODSNO
				INNER JOIN t_goods_option_detail tgod ON tcg.GOODSNO  = tgod.GOODSNO 
					AND tcg.OPTIONCODE  = tgod.OPTIONCODE
#				LEFT JOIN t_goods tg2 ON tcg.ORGGOODSNO = tg2.GOODSNO
#				LEFT JOIN t_goods_option_detail tgod2 ON tcg.ORGGOODSNO  = tgod2.GOODSNO 
#					AND tcg.OPTIONCODE  = tgod2.OPTIONCODE
				LEFT JOIN t_goods_review tgr ON tgr.ORDERIDX  = tcg.ORDERIDX
					AND tgr.ORDGDIDX  = tcg.ORDGDIDX
					AND tgr.ISTRASH  = 'F'
					AND tgr.SITEID = #{siteid}
				LEFT OUTER JOIN (
	                    SELECT goodsno
	                        , SUM(TOTPOINT) AS totalpoint
	                        , count(goodsno) AS totalcnt 
	                    FROM t_goods_review
	                    WHERE SITEID = #{siteid}
	                    AND ISTRASH  = 'F'
	                    GROUP  BY goodsno 
	                 ) tgr2 ON tgr.GOODSNO = tgr2.goodsno
			    LEFT OUTER JOIN ( 
			           SELECT reviewidx
			                , count(*) as noticnt
			           FROM t_review_noti
			           GROUP BY reviewidx
			        ) trn ON tgr.reviewidx = trn.reviewidx
			   LEFT OUTER JOIN (
			           SELECT reviewidx
			                 , count(*) as goodcnt
			           FROM t_review_help
			           GROUP BY reviewidx
			       ) trh ON tgr.reviewidx = trh.reviewidx
			WHERE 1 = 1
			AND tc.ISTRASH  = 'F'
			<if test='orderidx != null and orderidx != ""'>
			AND tcg.ORDERIDX = #{orderidx}
			</if>
			<if test='ordgdidx != null and ordgdidx != ""'>
			AND tcg.ORDGDIDX = #{ordgdidx}
			</if>
			<if test='reviewidx != null and reviewidx != ""'>
			AND tgr.REVIEWIDX = #{reviewidx}
			</if>
		) A 
		WHERE A.ORDSTATUS = 'ODS009'
    </select>
    
    <select id="selectReviewCnt" parameterType="somap" resultType="int">
     SELECT /*GoodsReviewMapper.xml - selectReviewCnt::회원의 작성 리뷰 수 조회*/
            COUNT(*)
     FROM t_goods_review
     WHERE GOODSNO = #{goodsno}
    </select>
    
    <!-- 리뷰저장 처리 -->
    <insert id="insertGoodsReview" parameterType= "somap">
	    /*GoodsReviewMapper.xml - insertGoodsReview 상품리뷰 작성*/
	    INSERT INTO t_goods_review(
	    	  siteid       -- 사이트id
	    	, goodsno      -- 상품번호
	    	, userno       -- 작성자번호
	    	, content      -- 내용
	    	, designpoint  -- 디자인 점수(추후삭제)
	    	, delivpoint   -- 배송점수(추후삭제)
	    	, pricepoint   -- 가격점수(추후삭제)
	    	, convpoint    -- 편리성점수(추후삭제)
	    	, totpoint     -- 총점수
	    	, isbest       -- 베스트리뷰여부
	    	, isexp        -- 체험단리뷰여부(추후삭제)
	    	, isblind      -- 블라인드여부(추후삭제)
	    	, isnoti       -- 신고여부
	    	, reguserid    -- 등록자id
	    	, regdate      -- 등록일시
	    	, moduserid    -- 수정자id
	    	, moddate      -- 수정일시
	    	, orderidx     -- 주문idx
	    	, isdisplay    -- 노출여부
	    	, beststtime   -- 베스트전시시작일
	    	, bestedtime   -- 베스트전시종료일
	    	, ordgdidx     -- 주문상품idx
	    )VALUES(
	    	#{siteid}
	      , #{goodsno}
	      , #{userno}
	      , #{content}
	      , 0   -- 추후삭제
	      , 0   -- 추후삭제
	      , 0   -- 추후삭제
	      , 0   -- 추후삭제
	      , #{totpoint}
	      , 'F'
	      , 'F' -- 추후삭제
	      , 'F' -- 추후삭제
	      , 'F'
	      , #{userid}
	      , now()
	      , null
	      , null
	      , #{orderidx}
	      , 'T'
	      , null
	      , null
	      , #{ordgdidx}
	     )
	     <selectKey resultType="int" keyProperty="reviewidx" order="AFTER">
	       SELECT LAST_INSERT_ID()
	   	 </selectKey>
    </insert>
    
    <select id="selectReviewIsNoti" parameterType="somap"  resultType="somap">
    SELECT isnoti
    FROM T_GOODS_REVIEW
    WHERE REVIEWIDX = #{reviewidx}
    </select>
    
    <update id="updateFrontGoodsReview" parameterType="somap">
    	/*GoodsReviewMapper.xml - updateFrontGoodsReview:: Front 리뷰 수정*/
    	UPDATE t_goods_review
    	SET
    	     moduserid = #{userid}
    	   , moddate = now()
    	   <if test='content != null and content !=""'> 
    	   , content = #{content}
    	   </if>
    	   <if test='totpoint != null and totpoint !=""'>
    	   , totpoint = #{totpoint}
    	   </if>
    	   <if test='isnoti != null and isnoti != ""'>
    	   , isnoti = #{isnoti}
    	   </if>
    	WHERE reviewidx = #{reviewidx}
    </update>
    
    <update id="updateReviewIstrash" parameterType="somap">
     /*GoodsReviewMapper.xml - updateReviewIstrash:: Front 리뷰 삭제처리*/
    	UPDATE t_goods_review
    	SET istrash = 'T'
    	  , moduserid = #{userid}
    	  , moddate = now()
    	WHERE reviewidx = #{reviewidx}
    </update>
    
    

</mapper>