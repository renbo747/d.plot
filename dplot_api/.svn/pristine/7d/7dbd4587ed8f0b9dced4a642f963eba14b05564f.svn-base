<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dplot.mapper.CouponMapper">
	<!-- 쿠폰목록 조회 -->
	<select id="selectCouponList" parameterType="somap" resultType="somap">
		SELECT /* CouponMapper.xml - selectCouponList 쿠폰목록 조회 */
		      C.COMCPNIDX           	/* 공통쿠폰IDX */
		    , CI.CPNINFOIDX				/* 공통쿠폰정보IDX */
		    , C.COMCPNNO  	      		/* 공통쿠폰번호 */
			, CI.CPNNAME            	/* 쿠폰명 */
		    , C.COMCPNTYPE          	/* 쿠폰종류 */
		    , FN_GET_CODENAME(NULL, 'COMCPNTYPE', C.COMCPNTYPE) AS COMCPNTYPENAME       /* 쿠폰종류명 */
		    , C.CPNISSUETYPE        	/* 쿠폰발급종류 */
		    , FN_GET_CODENAME(NULL, 'CPNISSUETYPE', C.CPNISSUETYPE) AS CPNISSUETYPENAME /* 쿠폰발급종류명 */
		    , C.PARTRATIO           	/* 파트너부담비율 */
		    , IFNULL(ISSUECNT, 0) AS ISSUECNT   			/* 발급건수 */
		    , IFNULL(USECNT, 0) AS USECNT       			/* 사용건수 */
		    , DATE_FORMAT(C.REGDATE, '%Y-%m-%d') AS REGDATE /* 등록일시 */
		    , C.CPNUSETYPE          	/* 사용기간종류 */
		    , FN_GET_CODENAME(NULL, 'CPNUSETYPE', C.CPNUSETYPE) AS CPNUSETYPENAME       			 /* 사용기간종류명 */
		    , (CASE WHEN C.CPNUSETYPE = 'CUT001' /* 기간설정 */
		    		THEN CONCAT(DATE_FORMAT(STR_TO_DATE(CI.CPNUSESTDAY, '%Y%m%d%H%i'), '%Y-%m-%d %H:%i'), ' ~ ', DATE_FORMAT(STR_TO_DATE(CI.CPNUSEEDDAY, '%Y%m%d%H%i'), '%Y-%m-%d %H:%i'))
		    		WHEN C.CPNUSETYPE = 'CUT002' /* 발급일기준 */
		    		THEN CONCAT('발급일 기준 ', FORMAT(ISSUEDAYCNT, 0), '일간 사용 가능')
		    		WHEN C.CPNUSETYPE = 'CUT003' /* 발급당월말까지 */
		    		THEN '발급 당월 말일까지'
		    		ELSE ''
		       END) CPNUSETYPECONTS		/* 사용기간내용 */
		    , C.ISSUEDAYCNT				/* 발급일기준쿠폰사용일 */
		    , C.MUAPPCHTYPE         	/* 다중적용채널 */
		    , FN_GET_CODENAME_STR(C.MUAPPCHTYPE, 'MUAPPCHTYPE') AS MUAPPCHTYPENAME      /* 다중적용채널명 */
		    , C.ISPERCENT           	/* 정률여부 */
		    , (CASE WHEN C.ISPERCENT = 'T' THEN CONCAT('정률(', FORMAT(C.DISPERCENT,0), '%)')
		            WHEN C.ISPERCENT = 'F' THEN CONCAT('정액(', FORMAT(C.DISPRICE, 0), '원)')
		            ELSE ''
		       END) AS DISCOUNTCONTS	/* 할인내역(정률여부) */
		    , C.DISPRICE            	/* 할인액 */
		    , C.DISPERCENT          	/* 할인률 */
		    , CI.CPNISSUEST          	/* 쿠폰발급상태 */
		    , FN_GET_CODENAME(NULL, 'CPNISSUEST', CI.CPNISSUEST) AS CPNISSUESTNAME       /* 쿠폰발급상태명 */
		    , C.ISTRASH             	/* 사용여부 */
		    , (CASE WHEN C.ISTRASH = 'F' THEN '사용'
		            WHEN C.ISTRASH = 'T' THEN '미사용'
		            ELSE ''
		       END) AS ISTRASHNAME		/* 사용여부 */
		    , C.ISAUTOPAY           	/* 자동지급여부 */
		    , (CASE WHEN C.ISAUTOPAY = 'T' THEN '자동적용'
		            WHEN C.ISAUTOPAY = 'F' THEN '다운로드'
		            ELSE ''
		       END) AS ISAUTOPAYNAME	/* 자동지급여부 */
		FROM T_COMCOUPON C
		INNER JOIN T_COMCOUPON_INFO CI ON C.COMCPNIDX = CI.COMCPNIDX
		LEFT OUTER JOIN
		    (  SELECT A.CPNINFOIDX
		            , SUM(CASE WHEN A.ISSUEDATE IS NOT NULL THEN 1 ELSE 0 END) AS ISSUECNT
		            , SUM(CASE WHEN A.USEDATE IS NOT NULL THEN 1 ELSE 0 END) AS USECNT
		       FROM T_COMCOUPON_MEMISSUE A
			   INNER JOIN T_COMCOUPON_INFO B ON A.CPNINFOIDX = B.CPNINFOIDX
			   INNER JOIN T_COMCOUPON C ON B.COMCPNIDX = C.COMCPNIDX
		       WHERE A.ISTRASH = 'F'
		       AND (C.ISAUTOPAY = 'T' OR (C.ISAUTOPAY = 'F' AND A.ISDOWNLOAD = 'T'))
		       GROUP BY A.CPNINFOIDX
		    ) CM ON CI.CPNINFOIDX = CM.CPNINFOIDX
		WHERE C.SITEID = #{siteid}
		AND CI.CPNDELTYPE = 'CDE001'
		<if test="sword != null and sword != '' ">
			<choose>
				<when test="skey == 'comcpnno'">
				AND C.COMCPNNO LIKE CONCAT('%', #{sword}, '%')
				</when>
				<when test="skey == 'cpnname'">
				AND CI.CPNNAME LIKE CONCAT('%', #{sword}, '%')
				</when>
				<otherwise>
				AND ( C.COMCPNNO LIKE CONCAT('%', #{sword}, '%')
				   OR CI.CPNNAME LIKE CONCAT('%', #{sword}, '%') )
				</otherwise>
			</choose>
		</if>
		<if test="(startdate != null and startdate != '') and (enddate == null or enddate == '') ">
		AND DATEDIFF(C.REGDATE, STR_TO_DATE(#{startdate},'%Y-%m-%d')) <![CDATA[>=]]> 0
		</if>
		<if test="(startdate == null or startdate == '') and (enddate != null and enddate != '') ">
		AND DATEDIFF(STR_TO_DATE(#{enddate},'%Y-%m-%d'), C.REGDATE) <![CDATA[>=]]> 0
		</if>
		<if test="(startdate != null and startdate != '') and (enddate != null and enddate != '') ">
		AND C.REGDATE BETWEEN STR_TO_DATE(CONCAT(#{startdate},'000000'), '%Y-%m-%d%H%i%s') AND STR_TO_DATE(CONCAT(#{enddate},'235959'), '%Y-%m-%d%H%i%s')
		</if>
		<if test="istrash != null and istrash != ''">
		AND C.ISTRASH = #{istrash}
		</if>
		<if test='comcpntypearr != null and comcpntypearr.size > 0'>
		AND
			<foreach index="index" collection="comcpntypearr" item="_item" open="(" close=")" separator="OR" >
				C.COMCPNTYPE LIKE CONCAT('%', #{_item}, '%')
			</foreach>
		</if>
		<if test='ispercentall != null and ispercentall == "F" and ispercentarr != null and ispercentarr.size > 0'>
		AND
			<foreach index="index" collection="ispercentarr" item="_item" open="(" close=")" separator="OR" >
				C.ISPERCENT = #{_item}
			</foreach>
		</if>
		<if test='muappchtypearr != null and muappchtypearr.size > 0'>
		AND
			<foreach index="index" collection="muappchtypearr" item="_item" open="(" close=")" separator="OR" >
				C.MUAPPCHTYPE LIKE CONCAT('%', #{_item}, '%')
			</foreach>
		</if>
		<if test='cpnissuestarr != null and cpnissuestarr.size > 0'>
		AND
			<foreach index="index" collection="cpnissuestarr" item="_item" open="(" close=")" separator="OR" >
				CI.CPNISSUEST LIKE CONCAT('%', #{_item}, '%')
			</foreach>
		</if>
		<if test='cpnissuetypearr != null and cpnissuetypearr.size > 0'>
		AND
			<foreach index="index" collection="cpnissuetypearr" item="_item" open="(" close=")" separator="OR" >
				C.CPNISSUETYPE LIKE CONCAT('%', #{_item}, '%')
			</foreach>
		</if>
		<choose>
			<when test="psort == 'partratio_asc'">
			ORDER BY C.PARTRATIO ASC, CI.CPNINFOIDX DESC
			</when>
			<when test="psort == 'partratio_desc'">
			ORDER BY C.PARTRATIO DESC, CI.CPNINFOIDX DESC
			</when>
			<when test="psort == 'regdate_asc'">
			ORDER BY C.REGDATE ASC, CI.CPNINFOIDX DESC
			</when>
			<when test="psort == 'regdate_desc'">
			ORDER BY C.REGDATE DESC, CI.CPNINFOIDX DESC
			</when>
			<otherwise>
			ORDER BY CI.CPNINFOIDX DESC
			</otherwise>
		</choose>
		<if test="startpage != null and !startpage.equals('') and endpage != null and !endpage.equals('')">
		LIMIT #{startpage}, #{endpage}
		</if>
	</select>

	<!-- 쿠폰 상태별 건수 조회  -->
	<select id="selectCouponStateList" parameterType="somap" resultType="somap">
		SELECT /* CouponMapper.xml - selectCouponStateList 쿠폰 상태별 건수 조회 */
			  COUNT(*) AS TOTALCNT						/* 전체건수 */
			, IFNULL(SUM(TA.PREVCNT), 0) AS PREVCNT		/* 쿠폰발급상태-발급전 */
			, IFNULL(SUM(TA.ISSUECNT), 0) AS ISSUECNT	/* 쿠폰발급상태-발급중 */
			, IFNULL(SUM(TA.STOPCNT), 0) AS STOPCNT		/* 쿠폰발급상태-발급중지 */
			, IFNULL(SUM(TA.ENDDCNT), 0) AS ENDCNT		/* 쿠폰발급상태-발급완료 */
		FROM (	SELECT
					  (CASE WHEN CI.CPNISSUEST = 'CIS001' THEN 1 ELSE 0 END) AS PREVCNT	/* 쿠폰발급상태-발급전 */
					, (CASE WHEN CI.CPNISSUEST = 'CIS002' THEN 1 ELSE 0 END) AS ISSUECNT/* 쿠폰발급상태-발급중 */
					, (CASE WHEN CI.CPNISSUEST = 'CIS003' THEN 1 ELSE 0 END) AS STOPCNT	/* 쿠폰발급상태-발급중지 */
					, (CASE WHEN CI.CPNISSUEST = 'CIS004' THEN 1 ELSE 0 END) AS ENDDCNT	/* 쿠폰발급상태-발급완료 */
				FROM T_COMCOUPON C
				INNER JOIN T_COMCOUPON_INFO CI ON C.COMCPNIDX = CI.COMCPNIDX
				WHERE C.SITEID = #{siteid}
				AND CI.CPNDELTYPE = 'CDE001'
				<if test="sword != null and sword != '' ">
					<choose>
						<when test="skey == 'comcpnno'">
						AND C.COMCPNNO LIKE CONCAT('%', #{sword}, '%')
						</when>
						<when test="skey == 'cpnname'">
						AND CI.CPNNAME LIKE CONCAT('%', #{sword}, '%')
						</when>
						<otherwise>
						AND ( C.COMCPNNO LIKE CONCAT('%', #{sword}, '%')
						   OR CI.CPNNAME LIKE CONCAT('%', #{sword}, '%') )
						</otherwise>
					</choose>
				</if>
				<if test="(startdate != null and startdate != '') and (enddate == null or enddate == '') ">
				AND DATEDIFF(C.REGDATE, STR_TO_DATE(#{startdate},'%Y-%m-%d')) <![CDATA[>=]]> 0
				</if>
				<if test="(startdate == null or startdate == '') and (enddate != null and enddate != '') ">
				AND DATEDIFF(STR_TO_DATE(#{enddate},'%Y-%m-%d'), C.REGDATE) <![CDATA[>=]]> 0
				</if>
				<if test="(startdate != null and startdate != '') and (enddate != null and enddate != '') ">
				AND C.REGDATE BETWEEN STR_TO_DATE(CONCAT(#{startdate},'000000'), '%Y-%m-%d%H%i%s') AND STR_TO_DATE(CONCAT(#{enddate},'235959'), '%Y-%m-%d%H%i%s')
				</if>
				<if test="istrash != null and istrash != ''">
				AND C.ISTRASH = #{istrash}
				</if>
				<if test='comcpntypearr != null and comcpntypearr.size > 0'>
				AND
					<foreach index="index" collection="comcpntypearr" item="_item" open="(" close=")" separator="OR" >
						C.COMCPNTYPE LIKE CONCAT('%', #{_item}, '%')
					</foreach>
				</if>
				<if test='ispercentall != null and ispercentall == "F" and ispercentarr != null and ispercentarr.size > 0'>
				AND
					<foreach index="index" collection="ispercentarr" item="_item" open="(" close=")" separator="OR" >
						C.ISPERCENT = #{_item}
					</foreach>
				</if>
				<if test='muappchtypearr != null and muappchtypearr.size > 0'>
				AND
					<foreach index="index" collection="muappchtypearr" item="_item" open="(" close=")" separator="OR" >
						C.MUAPPCHTYPE LIKE CONCAT('%', #{_item}, '%')
					</foreach>
				</if>
				<if test='cpnissuestarr != null and cpnissuestarr.size > 0'>
				AND
					<foreach index="index" collection="cpnissuestarr" item="_item" open="(" close=")" separator="OR" >
						CI.CPNISSUEST LIKE CONCAT('%', #{_item}, '%')
					</foreach>
				</if>
				<if test='cpnissuetypearr != null and cpnissuetypearr.size > 0'>
				AND
					<foreach index="index" collection="cpnissuetypearr" item="_item" open="(" close=")" separator="OR" >
						C.CPNISSUETYPE LIKE CONCAT('%', #{_item}, '%')
					</foreach>
				</if>
			 ) TA
	</select>

	<!-- 쿠폰목록 조회(엑셀용) -->
	<select id="selectCouponListForExcel" parameterType="somap" resultType="somap">
		SELECT /* CouponMapper.xml - selectCouponList 쿠폰목록 조회(엑셀용) */
		      C.COMCPNNO      			/* 공통쿠폰번호 */
			, CI.CPNNAME           	 	/* 쿠폰명 */
		    , FN_GET_CODENAME(NULL, 'COMCPNTYPE', C.COMCPNTYPE) AS COMCPNTYPENAME       /* 쿠폰종류명 */
		    , FN_GET_CODENAME(NULL, 'CPNISSUETYPE', C.CPNISSUETYPE) AS CPNISSUETYPENAME /* 쿠폰발급종류명 */
		    , (CASE WHEN C.PARTRATIO IS NOT NULL THEN CONCAT(C.PARTRATIO, '%') ELSE ''END) AS PARTRATIO	/* 파트너부담비율 */
		    , CONCAT(IFNULL(CM.ISSUECNT, 0), '/', IFNULL(CM.USECNT, 0)) AS ISSUEUSECNT   		/* 발급/사용건수 */
		    , DATE_FORMAT(C.REGDATE, '%Y-%m-%d') AS REGDATE 							/* 등록일시 */
		    , (CASE WHEN C.CPNUSETYPE = 'CUT001' /* 기간설정 */
		    		THEN CONCAT(DATE_FORMAT(STR_TO_DATE(CI.CPNUSESTDAY, '%Y%m%d%H%i'), '%Y-%m-%d %H:%i'), ' ~ ', DATE_FORMAT(STR_TO_DATE(CI.CPNUSEEDDAY, '%Y%m%d%H%i'), '%Y-%m-%d %H:%i'))
		    		WHEN C.CPNUSETYPE = 'CUT002' /* 발급일기준 */
		    		THEN CONCAT('발급일 기준 ', FORMAT(ISSUEDAYCNT, 0), '일간 사용 가능')
		    		WHEN C.CPNUSETYPE = 'CUT003' /* 발급당월말까지 */
		    		THEN '발급 당월 말일까지'
		    		ELSE ''
		       END) CPNUSETYPECONTS		/* 사용기간내용 */
		    , FN_GET_CODENAME_STR(C.MUAPPCHTYPE, 'MUAPPCHTYPE') AS MUAPPCHTYPENAME      /* 다중적용채널명 */
		    , (CASE WHEN C.ISPERCENT = 'T' THEN CONCAT('정률(', FORMAT(C.DISPERCENT,0), '%)')
		            WHEN C.ISPERCENT = 'F' THEN CONCAT('정액(', FORMAT(C.DISPRICE, 0), '원)')
		            ELSE ''
		       END) AS DISCOUNTCONTS	/* 할인내역(정률여부) */
		    , FN_GET_CODENAME(NULL, 'CPNISSUEST', CI.CPNISSUEST) AS CPNISSUESTNAME       /* 쿠폰발급상태명 */
		    , (CASE WHEN C.ISTRASH = 'F' THEN '사용'
		            WHEN C.ISTRASH = 'T' THEN '미사용'
		            ELSE ''
		       END) AS ISTRASHNAME		/* 사용여부 */
		    , (CASE WHEN C.ISAUTOPAY = 'T' THEN '자동적용'
		            WHEN C.ISAUTOPAY = 'F' THEN '다운로드'
		            ELSE ''
		       END) AS ISAUTOPAYNAME	/* 자동지급여부 */
		FROM T_COMCOUPON C
		INNER JOIN T_COMCOUPON_INFO CI ON C.COMCPNIDX = CI.COMCPNIDX
		LEFT OUTER JOIN
		    (  SELECT CPNINFOIDX
		            , SUM(CASE WHEN ISSUEDATE IS NOT NULL THEN 1 ELSE 0 END) AS ISSUECNT
		            , SUM(CASE WHEN USEDATE IS NOT NULL THEN 1 ELSE 0 END) AS USECNT
		       FROM T_COMCOUPON_MEMISSUE
		       GROUP BY CPNINFOIDX
		    ) CM ON CI.CPNINFOIDX = CM.CPNINFOIDX
		WHERE C.SITEID = #{siteid}
		AND CI.CPNDELTYPE = 'CDE001'
		<if test="sword != null and sword != '' ">
			<choose>
				<when test="skey == 'comcpnno'">
				AND C.COMCPNNO LIKE CONCAT('%', #{sword}, '%')
				</when>
				<when test="skey == 'cpnname'">
				AND CI.CPNNAME LIKE CONCAT('%', #{sword}, '%')
				</when>
				<otherwise>
				AND ( C.COMCPNNO LIKE CONCAT('%', #{sword}, '%')
				   OR CI.CPNNAME LIKE CONCAT('%', #{sword}, '%') )
				</otherwise>
			</choose>
		</if>
		<if test="(startdate != null and startdate != '') and (enddate == null or enddate == '') ">
		AND DATEDIFF(C.REGDATE, STR_TO_DATE(#{startdate},'%Y-%m-%d')) <![CDATA[>=]]> 0
		</if>
		<if test="(startdate == null or startdate == '') and (enddate != null and enddate != '') ">
		AND DATEDIFF(STR_TO_DATE(#{enddate},'%Y-%m-%d'), C.REGDATE) <![CDATA[>=]]> 0
		</if>
		<if test="(startdate != null and startdate != '') and (enddate != null and enddate != '') ">
		AND C.REGDATE BETWEEN STR_TO_DATE(CONCAT(#{startdate},'000000'), '%Y-%m-%d%H%i%s') AND STR_TO_DATE(CONCAT(#{enddate},'235959'), '%Y-%m-%d%H%i%s')
		</if>
		<if test="istrash != null and istrash != ''">
		AND C.ISTRASH = #{istrash}
		</if>
		<if test='comcpntypearr != null and comcpntypearr.size > 0'>
		AND
			<foreach index="index" collection="comcpntypearr" item="_item" open="(" close=")" separator="OR" >
				C.COMCPNTYPE LIKE CONCAT('%', #{_item}, '%')
			</foreach>
		</if>
		<if test='ispercentall != null and ispercentall == "F" and ispercentarr != null and ispercentarr.size > 0'>
		AND
			<foreach index="index" collection="ispercentarr" item="_item" open="(" close=")" separator="OR" >
				C.ISPERCENT = #{_item}
			</foreach>
		</if>
		<if test='muappchtypearr != null and muappchtypearr.size > 0'>
		AND
			<foreach index="index" collection="muappchtypearr" item="_item" open="(" close=")" separator="OR" >
				C.MUAPPCHTYPE LIKE CONCAT('%', #{_item}, '%')
			</foreach>
		</if>
		<if test='cpnissuestarr != null and cpnissuestarr.size > 0'>
		AND
			<foreach index="index" collection="cpnissuestarr" item="_item" open="(" close=")" separator="OR" >
				CI.CPNISSUEST LIKE CONCAT('%', #{_item}, '%')
			</foreach>
		</if>
		<if test='cpnissuetypearr != null and cpnissuetypearr.size > 0'>
		AND
			<foreach index="index" collection="cpnissuetypearr" item="_item" open="(" close=")" separator="OR" >
				C.CPNISSUETYPE LIKE CONCAT('%', #{_item}, '%')
			</foreach>
		</if>
		<choose>
			<when test="psort == 'partratio_asc'">
			ORDER BY C.PARTRATIO ASC, CI.CPNINFOIDX DESC
			</when>
			<when test="psort == 'partratio_desc'">
			ORDER BY C.PARTRATIO DESC, CI.CPNINFOIDX DESC
			</when>
			<when test="psort == 'regdate_asc'">
			ORDER BY C.REGDATE ASC, CI.CPNINFOIDX DESC
			</when>
			<when test="psort == 'regdate_desc'">
			ORDER BY C.REGDATE DESC, CI.CPNINFOIDX DESC
			</when>
			<otherwise>
			ORDER BY CI.CPNINFOIDX DESC
			</otherwise>
		</choose>
	</select>

	<!-- 쿠폰 상세 조회 -->
	<select id="selectCouponDetail" parameterType="somap" resultType="somap">
		SELECT  /* CouponMapper.xml - selectCouponDetail 쿠폰 상세 조회 */
			  C.COMCPNIDX			/* 공통쿠폰IDX */
		    , CI.CPNINFOIDX			/* 공통쿠폰정보IDX */
			, C.COMCPNNO			/* 쿠폰번호 */
			, DATE_FORMAT(C.REGDATE, '%Y-%m-%d') AS REGDATE	/* 등록일시 */
			, DATE_FORMAT(C.MODDATE, '%Y-%m-%d') AS MODDATE	/* 수정일시 */
			, C.COMCPNTYPE  		/* 쿠폰종류 */
			, C.CPNISSUETYPE  		/* 쿠폰발급종류 */
			, CI.CPNISSUEST			/* 쿠폰발급상태 */
			, T.TOTCPNCNT			/* 전체쿠폰수 */
			, T.BFISSUECNT			/* 발급전쿠폰수 */
			, C.ISTRASH  			/* 삭제여부 */
			, C.CPNNAME  			/* 쿠폰명 */
			, C.CPNDESC  			/* 설명 */
			, C.ISMEMTYPE  			/* 특정유형등급대상여부 */
			, C.MUMEMBERTYPE  		/* 다중대상회원유형 */
			, C.MUMEMLVTYPE  		/* 다중대상회원등급 */
			, C.ISRCVLIMIT  		/* 수신동의제한여부 */
			, C.MUMEMRCVTYPE  		/* 다중수신동의 */
			, C.ISTOTCATE  			/* 전체카테고리여부 */
			, C.GOODSRANGETYPE  	/* 대상상품범위 */
			, C.PARTRATIO  			/* 파트너부담비율 */
			, C.CPNUSETYPE  		/* 사용기간종류 */
			, C.ISSUEDAYCNT  		/* 발급일기준쿠폰사용일 */
			, CI.CPNUSESTDAY  		/* 쿠폰사용시작일 */
			, CI.CPNUSEEDDAY  		/* 쿠폰사용종료일 */
		    , IF(CI.CPNUSESTDAY IS NULL OR CI.CPNUSESTDAY = '', '', DATE_FORMAT(STR_TO_DATE(CI.CPNUSESTDAY, '%Y%m%d%H%i'), '%Y-%m-%d')) AS CPNUSESTDATE
		    , IF(CI.CPNUSESTDAY IS NULL OR CI.CPNUSESTDAY = '', '', DATE_FORMAT(STR_TO_DATE(CI.CPNUSESTDAY, '%Y%m%d%H%i'), '%H')) AS CPNUSESTHOUR
		    , IF(CI.CPNUSESTDAY IS NULL OR CI.CPNUSESTDAY = '', '', DATE_FORMAT(STR_TO_DATE(CI.CPNUSESTDAY, '%Y%m%d%H%i'), '%i')) AS CPNUSESTMIN
		    , IF(CI.CPNUSEEDDAY IS NULL OR CI.CPNUSEEDDAY = '', '', DATE_FORMAT(STR_TO_DATE(CI.CPNUSEEDDAY, '%Y%m%d%H%i'), '%Y-%m-%d')) AS CPNUSEEDDATE
		    , IF(CI.CPNUSEEDDAY IS NULL OR CI.CPNUSEEDDAY = '', '', DATE_FORMAT(STR_TO_DATE(CI.CPNUSEEDDAY, '%Y%m%d%H%i'), '%H')) AS CPNUSEEDHOUR
		    , IF(CI.CPNUSEEDDAY IS NULL OR CI.CPNUSEEDDAY = '', '', DATE_FORMAT(STR_TO_DATE(CI.CPNUSEEDDAY, '%Y%m%d%H%i'), '%i')) AS CPNUSEEDMIN
			, C.MUAPPCHTYPE  		/* 다중적용채널 */
			, C.ISORDERLIMIT  		/* 사용가능금액적용여부 */
			, C.ORLIMITAMT  		/* 사용가능기준금액 */
			, C.ISPERCENT  			/* 정률여부 */
			, C.DISPRICE  			/* 할인액 */
			, C.DISPERCENT  		/* 할인률 */
			, C.MAXDISAMT  			/* 최대할인금액 */
			, C.ISRVMARGIN  		/* 역마진체크여부 */
			, C.ISNOWISSUE  		/* 즉시발급여부 */
			, C.CPNISSUEDAY  		/* 발급일시 */
		    , IF(C.CPNISSUEDAY IS NULL OR C.CPNISSUEDAY = '', '', DATE_FORMAT(STR_TO_DATE(C.CPNISSUEDAY, '%Y%m%d%H%i'), '%Y-%m-%d')) AS CPNISSUEDATE
		    , IF(C.CPNISSUEDAY IS NULL OR C.CPNISSUEDAY = '', '', DATE_FORMAT(STR_TO_DATE(C.CPNISSUEDAY, '%Y%m%d%H%i'), '%H')) AS CPNISSUEHOUR
		    , IF(C.CPNISSUEDAY IS NULL OR C.CPNISSUEDAY = '', '', DATE_FORMAT(STR_TO_DATE(C.CPNISSUEDAY, '%Y%m%d%H%i'), '%i')) AS CPNISSUEMIN
			, C.ISAUTOPAY  			/* 자동지급여부 */
			, C.ISCNTLIMT  			/* 쿠폰수량제한여부 */
			, C.CPNLIMTCNT  		/* 쿠폰수량제한 */
			, C.ISDUPPERSON  		/* 동일인재발급여부 */
			, C.DUPCNT  			/* 동일인재발급수량 */
			, C.MUCPNDUPTYPE  		/* 장바구니쿠폰중복사용범위용 */
			, C.ISBIRTHTHEDAY  		/* 생일쿠폰당일발급여부 */
			, C.BIRTHBFDAYCNT  		/* 생일쿠폰생일전발급일수 */
			, C.ISEVERYDAY  		/* 정기발급발급시점매일발급여부 */
			, C.EVERYDAYLOOP  		/* 정기발급반복일수 */
			, C.EVERYMONTHLOOP  	/* 정기발급반복월일 */
			, C.EVERYHHMM  			/* 정기발급발급시분 */
			, IF(C.EVERYHHMM IS NULL OR C.EVERYHHMM = '', '', SUBSTR(C.EVERYHHMM, 1, 2))  AS EVERYHH	/* 정기발급발급시 */
			, IF(C.EVERYHHMM IS NULL OR C.EVERYHHMM = '', '', SUBSTR(C.EVERYHHMM, 3, 2))  AS EVERYMM	/* 정기발급발급분 */
			, C.ISFIRSTORD  		/* 구매확정조건첫구매확정여부 */
			, C.ORDGDRANGETYPE  	/* 구매확정상품범위 */
			, C.ISORDTOTCATE  		/* 구매확정전체카테고리여부 */
			, C.EVRCPNUSESTDAY  	/* 정기발급 쿠폰사용시작일 */
			, C.EVRCPNUSEEDDAY  	/* 정기발급 쿠폰사용종료일 */
		    , IF(C.EVRCPNUSESTDAY IS NULL OR C.EVRCPNUSESTDAY = '', '', DATE_FORMAT(STR_TO_DATE(C.EVRCPNUSESTDAY, '%Y%m%d%H%i'), '%Y-%m-%d')) AS EVRCPNUSESTDATE
		    , IF(C.EVRCPNUSESTDAY IS NULL OR C.EVRCPNUSESTDAY = '', '', DATE_FORMAT(STR_TO_DATE(C.EVRCPNUSESTDAY, '%Y%m%d%H%i'), '%H')) AS EVRCPNUSESTHOUR
		    , IF(C.EVRCPNUSESTDAY IS NULL OR C.EVRCPNUSESTDAY = '', '', DATE_FORMAT(STR_TO_DATE(C.EVRCPNUSESTDAY, '%Y%m%d%H%i'), '%i')) AS EVRCPNUSESTMIN
		    , IF(C.EVRCPNUSEEDDAY IS NULL OR C.EVRCPNUSEEDDAY = '', '', DATE_FORMAT(STR_TO_DATE(C.EVRCPNUSEEDDAY, '%Y%m%d%H%i'), '%Y-%m-%d')) AS EVRCPNUSEEDDATE
		    , IF(C.EVRCPNUSEEDDAY IS NULL OR C.EVRCPNUSEEDDAY = '', '', DATE_FORMAT(STR_TO_DATE(C.EVRCPNUSEEDDAY, '%Y%m%d%H%i'), '%H')) AS EVRCPNUSEEDHOUR
		    , IF(C.EVRCPNUSEEDDAY IS NULL OR C.EVRCPNUSEEDDAY = '', '', DATE_FORMAT(STR_TO_DATE(C.EVRCPNUSEEDDAY, '%Y%m%d%H%i'), '%i')) AS EVRCPNUSEEDMIN
		FROM T_COMCOUPON C
		INNER JOIN T_COMCOUPON_INFO CI ON C.COMCPNIDX = CI.COMCPNIDX
		INNER JOIN (
			SELECT
				  COMCPNIDX
				, COUNT(*) AS TOTCPNCNT
				, SUM(CASE WHEN CPNISSUEST='CIS001' THEN 1 ELSE 0 END) AS BFISSUECNT
			FROM T_COMCOUPON_INFO
			GROUP BY COMCPNIDX
		) T ON CI.COMCPNIDX = T.COMCPNIDX
		WHERE C.SITEID = #{siteid}
		AND C.COMCPNIDX = #{comcpnidx}
		AND CI.CPNINFOIDX = #{cpninfoidx}
	</select>
	
	<!-- 쿠폰 저장 -->
	<insert id="insertCoupon" parameterType="somap" useGeneratedKeys="true" keyColumn="COMCPNIDX" keyProperty="comcpnidx">
		/* CouponMapper.xml - insertCoupon 쿠폰 저장 */
		INSERT INTO T_COMCOUPON (
			  SITEID			/* 사이트ID */
			, COMCPNNO  		/* 쿠폰번호 */
			, COMCPNTYPE  		/* 쿠폰종류 */
			, CPNISSUETYPE  	/* 쿠폰발급종류 */
			, ISTRASH  			/* 삭제여부 */
			, CPNNAME			/* 쿠폰명 */
			, CPNDESC  			/* 설명 */
			, ISMEMTYPE  		/* 특정유형등급대상여부 */
			, MUMEMBERTYPE  	/* 다중대상회원유형 */
			, MUMEMLVTYPE  		/* 다중대상회원등급 */
			, ISRCVLIMIT  		/* 수신동의제한여부 */
			, MUMEMRCVTYPE  	/* 다중수신동의 */
			, ISTOTCATE  		/* 전체카테고리여부 */
			, GOODSRANGETYPE  	/* 대상상품범위 */
			, PARTRATIO  		/* 파트너부담비율 */
			, CPNUSETYPE  		/* 사용기간종류 */
			, ISSUEDAYCNT  		/* 발급일기준쿠폰사용일 */
			, MUAPPCHTYPE  		/* 다중적용채널 */
			, ISORDERLIMIT  	/* 사용가능금액적용여부 */
			, ORLIMITAMT  		/* 사용가능기준금액 */
			, ISPERCENT  		/* 정률여부 */
			, DISPRICE  		/* 할인액 */
			, DISPERCENT  		/* 할인률 */
			, MAXDISAMT  		/* 최대할인금액 */
			, ISRVMARGIN  		/* 역마진체크여부 */
			, ISNOWISSUE  		/* 즉시발급여부 */
			, ISAUTOPAY  		/* 자동지급여부 */
			, ISCNTLIMT  		/* 쿠폰수량제한여부 */
			, CPNLIMTCNT 	 	/* 쿠폰수량제한 */
			, ISDUPPERSON  		/* 동일인재발급여부 */
			, DUPCNT  			/* 동일인재발급수량 */
			, MUCPNDUPTYPE  	/* 장바구니쿠폰중복사용범위 */
			, ISBIRTHTHEDAY  	/* 생일쿠폰당일발급여부 */
			, BIRTHBFDAYCNT  	/* 생일쿠폰생일전발급일수 */
			, ISEVERYDAY  		/* 정기발급발급시점매일발급여부 */
			, EVERYDAYLOOP  	/* 정기발급반복일수 */
			, EVERYMONTHLOOP  	/* 정기발급반복월일 */
			, EVERYHHMM  		/* 정기발급발급시분 */
			, ISFIRSTORD  		/* 구매확정조건첫구매확정여부 */
			, ORDGDRANGETYPE  	/* 구매확정상품범 */
			, ISORDTOTCATE  	/* 구매확정전체카테고리여부 */
			, EVRCPNUSESTDAY	/* 정기발급사용시작일자 */
			, EVRCPNUSEEDDAY	/* 정기발급사용종료일자 */
			, CPNISSUEDAY		/* 발급일시 */
			, REGUSERID  		/* 등록자ID */
			, REGDATE  			/* 등록일시 */
			, MODUSERID  		/* 수정자ID */
			, MODDATE  			/* 수정일시 */
		) VALUES (
			  #{siteid}
			, FN_GET_COUPON_CODE()
			, #{comcpntype}
			, #{cpnissuetype}
			, #{istrash}
			, #{cpnname}
			, #{cpndesc}
			, #{ismemtype}
			, #{mumembertype}
			, #{mumemlvtype}
			, #{isrcvlimit}
			, #{mumemrcvtype}
			, #{istotcate}
			, #{goodsrangetype}
			, IF(#{partratio}='', null, #{partratio})
			, #{cpnusetype}
			, IF(#{issuedaycnt}='', null, #{issuedaycnt})
			, #{muappchtype}
			, #{isorderlimit}
			, IF(#{orlimitamt}='', null, #{orlimitamt})
			, #{ispercent}
			, IF(#{disprice}='', null, #{disprice})
			, IF(#{dispercent}='', null, #{dispercent})
			, IF(#{maxdisamt}='', null, #{maxdisamt})
			, #{isrvmargin}
			, #{isnowissue}
			, #{isautopay}
			, #{iscntlimt}
			, IF(#{cpnlimtcnt}='', null, #{cpnlimtcnt})
			, #{isdupperson}
			, IF(#{dupcnt}='', null, #{dupcnt})
			, #{mucpnduptype}
			, #{isbirththeday}
			, IF(#{birthbfdaycnt}='', null, #{birthbfdaycnt})
			, #{iseveryday}
			, IF(#{everydayloop}='', null, #{everydayloop})
			, IF(#{everymonthloop}='', null, #{everymonthloop})
			, #{everyhhmm}
			, #{isfirstord}
			, #{ordgdrangetype}
			, #{isordtotcate}
			, #{evrcpnusestday}
			, #{evrcpnuseedday}
			, #{cpnissueday}
			, #{authuserid}
			, NOW()
			, #{authuserid}
			, NOW()
		)
	</insert>
	
	<!-- 쿠폰 수정 -->
	<update id="updateCoupon" parameterType="somap">
		UPDATE T_COMCOUPON SET	/* CouponMapper.xml - updateCoupon 쿠폰 수정 */
			  COMCPNTYPE = #{comcpntype}
			, CPNISSUETYPE = #{cpnissuetype}
			, ISTRASH = #{istrash}
			, CPNNAME = #{cpnname}
			, CPNDESC = #{cpndesc}
			, ISMEMTYPE = #{ismemtype}
			, MUMEMBERTYPE = #{mumembertype}
			, MUMEMLVTYPE = #{mumemlvtype}
			, ISRCVLIMIT = #{isrcvlimit}
			, MUMEMRCVTYPE = #{mumemrcvtype}
			, ISTOTCATE = #{istotcate}
			, GOODSRANGETYPE = #{goodsrangetype}
			, PARTRATIO = IF(#{partratio}='', null, #{partratio})
			, CPNUSETYPE = #{cpnusetype}
			, ISSUEDAYCNT = IF(#{issuedaycnt}='', null, #{issuedaycnt})
			, MUAPPCHTYPE = #{muappchtype}
			, ISORDERLIMIT = #{isorderlimit}
			, ORLIMITAMT = IF(#{orlimitamt}='', null, #{orlimitamt})
			, ISPERCENT = #{ispercent}
			, DISPRICE = IF(#{disprice}='', null, #{disprice})
			, DISPERCENT = IF(#{dispercent}='', null, #{dispercent})
			, MAXDISAMT = IF(#{maxdisamt}='', null, #{maxdisamt})
			, ISRVMARGIN = #{isrvmargin}
			, ISNOWISSUE = #{isnowissue}
			, ISAUTOPAY = #{isautopay}
			, ISCNTLIMT = #{iscntlimt}
			, CPNLIMTCNT = IF(#{cpnlimtcnt}='', null, #{cpnlimtcnt})
			, ISDUPPERSON = #{isdupperson}
			, DUPCNT = IF(#{dupcnt}='', null, #{dupcnt})
			, MUCPNDUPTYPE = #{mucpnduptype}
			, ISBIRTHTHEDAY = #{isbirththeday}
			, BIRTHBFDAYCNT = IF(#{birthbfdaycnt}='', null, #{birthbfdaycnt})
			, ISEVERYDAY = #{iseveryday}
			, EVERYDAYLOOP = IF(#{everydayloop}='', null, #{everydayloop})
			, EVERYMONTHLOOP = IF(#{everymonthloop}='', null, #{everymonthloop})
			, EVERYHHMM = #{everyhhmm}
			, ISFIRSTORD = #{isfirstord}
			, ORDGDRANGETYPE = #{ordgdrangetype}
			, ISORDTOTCATE = #{isordtotcate}
			, EVRCPNUSESTDAY = #{evrcpnusestday}
			, EVRCPNUSEEDDAY = #{evrcpnuseedday}
			, CPNISSUEDAY = #{cpnissueday}
			, MODUSERID = #{authuserid}
			, MODDATE = NOW()
		WHERE SITEID = #{siteid}
		AND COMCPNIDX = #{comcpnidx}
	</update>
	
	<!-- 회원(프로모션)용 쿠폰 목록 조회 -->
	<select id="selectPromotionCouponList" parameterType="somap" resultType="somap">
		SELECT /* CouponMapper.xml - selectCouponList 쿠폰 목록 조회 */
			CONCAT('(', C.COMCPNNO,'/',FN_GET_CODENAME_STR(C.COMCPNTYPE,'COMCPNTYPE'),') ', CI.CPNNAME) as TITLE
			, C.COMCPNIDX as COMCPNIDX
		FROM T_COMCOUPON C
		INNER JOIN T_COMCOUPON_INFO CI ON C.COMCPNIDX = CI.COMCPNIDX
		<where>
			AND C.SITEID = #{siteid}
			AND C.ISTRASH = 'F' 
			AND CI.CPNISSUEST = 'CIS002'
			AND C.CPNISSUETYPE = 'CIT006'
		</where>
	</select>
	
	<select id="selectCouponByComcpnidx" parameterType="somap" resultType="somap">
		SELECT /* CouponMapper.xml - selectCouponByComcpnidx:: 쿠폰번호로 쿠폰정보조회*/
		       tc.COMCPNIDX 
			 , tc.COMCPNNO
			 , tc.COMCPNTYPE
			 , tc.CPNISSUETYPE
			 , tc.ISMEMTYPE
			 , tc.MUMEMBERTYPE
			 , tc.MUMEMLVTYPE
			 , tc.ISSUEDAYCNT
			 , tc.ISNOWISSUE
			 , tc.CPNUSETYPE
			 , tc.ISAUTOPAY
			 , tc.ISPERCENT	/* 정률여부 */
			 , tc.DISPRICE	/* 할인액 */
			 , tc.DISPERCENT	/* 할인률 */
			 , tc.MAXDISAMT	/* 최대할인금액 */
			 , tci.CPNINFOIDX
			 , tci.CPNUSESTDAY
			 , tci.CPNUSEEDDAY
			 , tci.CPNISSUEST
		FROM t_comcoupon tc
		INNER JOIN t_comcoupon_info tci ON tc.COMCPNIDX  = tci.COMCPNIDX
		WHERE 1 = 1
		AND tc.SITEID = #{siteid}
		AND tc.COMCPNIDX  = #{comcpnidx}
	</select>
	
	<select id="selectCouponInfo" parameterType="somap" resultType="somap">
		SELECT /* CouponMapper.xml - selectCouponInfo:: 쿠폰정보조회*/
		       COMCPNIDX 
			 , COMCPNNO
			 , CPNNAME
			 , COMCPNTYPE
			 , CPNISSUETYPE
			 , ISMEMTYPE
			 , MUMEMBERTYPE
			 , MUMEMLVTYPE
			 , ISSUEDAYCNT
			 , ISNOWISSUE
			 , CPNUSETYPE
			 , ISAUTOPAY
			 , ISPERCENT	/* 정률여부 */
			 , DISPRICE		/* 할인액 */
			 , DISPERCENT	/* 할인률 */
			 , IF(MAXDISAMT = 0, 99999999, MAXDISAMT) AS MAXDISAMT	/* 최대할인금액 */
			 , ISORDERLIMIT /* 사용가능금액적용여부 */
			 , ORLIMITAMT	/* 사용가능기준금액 */
		FROM t_comcoupon
		WHERE 1 = 1
		AND SITEID = #{siteid}
		AND COMCPNIDX  = #{comcpnidx}
	</select>
	
	<select id="selectSignupCoupon" parameterType="somap" resultType="somap">
		SELECT /*CouponMapper.xml - selectSignupCoupon:: 회원가입 쿠폰정보조회*/
		        tc.COMCPNIDX       -- 공통쿠폰IDX
		      , tc.COMCPNNO
		      , tci.CPNINFOIDX     -- 쿠폰발급정보IDX 
		      , tci.CPNNAME        -- 쿠폰명
		      , tc.ISNOWISSUE      -- 즉시발급여부
		      , tc.ISAUTOPAY       -- 자동지급여부
		      , tc.CPNUSETYPE 
		      , tc.CPNISSUETYPE
		      , tc.ISSUEDAYCNT 
		      , CASE 
		            WHEN tc.CPNISSUETYPE = 'CIT002' THEN
		                CASE 
		                    WHEN CPNUSETYPE = 'CUT001' THEN tci.CPNUSESTDAY
		                    ELSE DATE_FORMAT(NOW(), '%Y%m%d%H%i')
		                END
		            ELSE tci.CPNUSESTDAY
		        END AS CPNUSESTDAY -- 쿠폰사용시작일     
		      , CASE 
		            WHEN tc.CPNISSUETYPE = 'CIT002' THEN
		                CASE 
		                    WHEN CPNUSETYPE = 'CUT002' THEN DATE_FORMAT(DATE_ADD(NOW(), INTERVAL tc.ISSUEDAYCNT DAY), '%Y%m%d%H%i')
		                    WHEN CPNUSETYPE = 'CUT003' THEN DATE_FORMAT(LAST_DAY(NOW()), '%Y%m%d%H%i')
		                    ELSE tci.CPNUSEEDDAY
		                END
		            ELSE tci.CPNUSEEDDAY
		        END AS CPNUSEEDDAY -- 쿠폰사용종료일
		FROM t_comcoupon tc 
		INNER JOIN t_comcoupon_info tci 
		ON tc.COMCPNIDX  = tci.COMCPNIDX 
		WHERE tc.SITEID = #{siteid}
		AND tc.ISTRASH  = 'F'
		AND tc.CPNISSUETYPE IN ('CIT001','CIT002','CIT004') -- 즉시할인, 신규가입, 정기발급
		AND (tc.CPNISSUETYPE = 'CIT002' OR (tc.CPNISSUETYPE IN ('CIT001','CIT004') AND sysdate() between ifnull(STR_TO_DATE(tci.CPNISSUEDAY, '%Y%m%d%H%i'), DATE_ADD(sysdate(),  INTERVAL - 1 DAY)) and STR_TO_DATE(tci.CPNUSEEDDAY , '%Y%m%d%H%i')))
		AND tci.CPNISSUEST IN ('CIS002', 'CIS004') -- 발급중인것만 사용자에게 지급
		<choose>
	      <when test='islife == "F"'>
	      AND tc.ismemtype = 'T'  -- 특정유형/등급
	      AND tc.mumemlvtype like concat('%', #{memlvtype}, '%') 
	      AND tc.mumembertype like concat('%', #{membertype}, '%') 
	      AND tc.muappchtype like concat('%', #{muappchtype}, '%')
	      </when>
	      <otherwise>
	      AND tc.comcpnno = #{comcpnno}
	      </otherwise>
	    </choose>
	</select>

	<select id="selectOrderConfirmCoupon"  parameterType="somap" resultType="somap">
		/* CouponMapper - selectOrderConfirmCoupon 상품 구매확정 쿠폰 조회*/
        WITH coupon AS (
            SELECT
                  a.comcpnidx       -- 공통쿠폰idx
                , b.cpninfoidx      -- 쿠폰발급정보IDX
                , b.cpnname         -- 쿠폰명
                , a.comcpnno        -- 쿠폰번호
                , a.comcpntype      -- 쿠폰종류
                , a.cpnissuetype    -- 쿠폰발급종류
                , a.cpnusetype      -- 쿠폰사용기간종류
                , a.issuedaycnt     -- 발급일기준쿠폰사용일
                , a.isfirstord      -- 구매확정조건첫구매확정여부
                , a.isordtotcate    -- 전체카테고리여부
                , a.ordgdrangetype  -- 전체상품범위
                , a.isnowissue      -- 즉시발급여부
                , a.isautopay       -- 즉시발급여부
                , a.ismemtype		-- 특정유형대상여부
                , CASE 
                    WHEN cpnusetype = 'CUT001' THEN b.cpnusestday
                    ELSE DATE_FORMAT(NOW(), '%Y%m%d%H%i')
                  END AS cpnusestday -- 쿠폰사용시작일     
                , CASE 
                    WHEN cpnusetype = 'CUT002' THEN DATE_FORMAT(DATE_ADD(NOW(), INTERVAL a.issuedaycnt DAY), '%Y%m%d%H%i')
                    WHEN cpnusetype = 'CUT003' THEN DATE_FORMAT(LAST_DAY(NOW()), '%Y%m%d%H%i')
                    ELSE b.cpnuseedday
                  END AS CPNUSEEDDAY -- 쿠폰사용종료일
            FROM t_comcoupon a
            INNER JOIN t_comcoupon_info b 
            ON a.comcpnidx = b.comcpnidx 
            WHERE a.siteid = #{siteid}
            AND a.istrash = 'F'
            AND a.cpnissuetype = 'CIT005'
            AND (a.ismemtype = 'T' OR (a.ismemtype = 'F' AND  EXISTS (SELECT 1 FROM t_comcoupon_member WHERE userno = #{userno} AND comcpnidx = A.comcpnidx)))
            AND (a.cpnusetype <![CDATA[<>]]> 'CUT001' OR (a.cpnusetype = 'CUT001' AND date_format(sysdate(), '%Y%m%d%H%i') BETWEEN b.cpnusestday AND b.cpnuseedday))
            AND b.CPNISSUEST IN ('CIS002') -- 발급중
        ), allcoupon AS ( /* 전체카테고리 쿠폰, 전체상품 쿠폰 */
            SELECT comcpnidx
            FROM coupon
            WHERE (isfirstord = 'T' OR ordgdrangetype = 'GGT001')
        ), incatecoupon AS ( /* 추가카테고리 쿠폰 */
            SELECT a.comcpnidx, b.cateidx
            FROM coupon a
            INNER JOIN t_comcoupon_ord_cate b 
            ON a.comcpnidx = b.comcpnidx
            AND b.isadd = 'T'
            WHERE a.isordtotcate = 'F'
        ), ingoodscoupon AS ( /* 추가상품 쿠폰 */
            SELECT a.comcpnidx, b.goodsno, b.optioncode
            FROM coupon a
            INNER JOIN t_comcoupon_ord_goods b 
            ON a.comcpnidx = b.comcpnidx
            WHERE a.ordgdrangetype = 'GGT002'
        ), outcatecoupon AS ( /* 제외카테고리 쿠폰 */
            SELECT a.comcpnidx, b.cateidx
            FROM coupon a
            INNER JOIN t_comcoupon_ord_cate b 
            ON a.comcpnidx = b.comcpnidx
            AND b.isadd = 'F'
            WHERE a.isordtotcate = 'F'
        ), outgoodscoupon AS ( /* 제외상품 쿠폰 */
            SELECT a.comcpnidx, b.goodsno, b.optioncode
            FROM coupon a
            INNER JOIN t_comcoupon_ord_goods b 
            ON a.comcpnidx = b.comcpnidx
            WHERE a.ordgdrangetype = 'GGT003'
        ), goods AS (
            SELECT a.goodsno, a.optioncode, b.cateidx
            FROM t_goods_option_detail a
            LEFT JOIN t_goods_category b
            ON a.goodsno = b.goodsno
            WHERE a.goodsno = #{goodsno}
            AND a.optioncode = #{optioncode}
        )
        SELECT 
              ttt.*
        FROM (
            SELECT distinct
                  tt2.*
            FROM (
                /* 전체 적용쿠폰 */
                SELECT b.goodsno, b.optioncode, b.cateidx, a.comcpnidx
                FROM allcoupon a
                INNER JOIN goods b 
                UNION ALL
                /* 카페고리포함 적용쿠폰 */
                SELECT a.goodsno, a.optioncode, a.cateidx, b.comcpnidx
                FROM goods a
                INNER JOIN (
                    WITH RECURSIVE incate AS (
                        SELECT comcpnidx, cateidx
                        FROM incatecoupon
                        UNION ALL
                        SELECT t2.comcpnidx, idx
                        FROM t_category t1, incate t2
                        WHERE t1.parent = t2.cateidx
                    )
                    SELECT comcpnidx, cateidx
                    FROM incate
                ) b
                ON a.cateidx = b.cateidx
                UNION ALL
                /* 카페고리제회 적용쿠폰 */
                SELECT a.goodsno, a.optioncode, a.cateidx, b.comcpnidx
                FROM goods a
                INNER JOIN (
                    WITH RECURSIVE outcate AS (
                        SELECT comcpnidx, cateidx
                        FROM outcatecoupon
                        UNION ALL
                        SELECT t2.comcpnidx, idx
                        FROM t_category t1, outcate t2
                        WHERE t1.parent = t2.cateidx
                    )
                    SELECT comcpnidx, cateidx
                    FROM outcate
                ) b
                ON a.cateidx = b.cateidx
                WHERE b.cateidx IS NULL
                UNION ALL
                /* 특정상품포함 적용쿠폰 */
                SELECT a.goodsno, a.optioncode, a.cateidx, b.comcpnidx
                FROM goods a
                INNER JOIN ingoodscoupon b
                ON a.goodsno = b.goodsno
                AND a.optioncode = b.optioncode
                UNION ALL
                /* 특정상품제외 적용쿠폰 */
                SELECT a.goodsno, a.optioncode, a.cateidx, b.comcpnidx
                FROM goods a
                INNER JOIN outgoodscoupon b
                ON a.goodsno = b.goodsno
                AND a.optioncode = b.optioncode
            ) tt1
            INNER JOIN coupon tt2
            ON tt1.comcpnidx = tt2.comcpnidx
        ) ttt
	</select>

	<select id="selectGoodsCouponCnt"  parameterType="somap" resultType="int">
		/* CouponMapper - selectGoodsCouponCnt 상품 다운로드쿠폰 조회*/
        WITH coupon AS (
            SELECT
                  a.comcpnidx       -- 공통쿠폰idx
                , b.cpninfoidx      -- 쿠폰발급정보IDX
                , b.cpnname         -- 쿠폰명
                , a.comcpnno        -- 쿠폰번호
                , a.comcpntype      -- 쿠폰종류
                , a.cpnissuetype    -- 쿠폰발급종류
                , a.cpnusetype      -- 쿠폰사용기간종류
                , a.issuedaycnt     -- 발급일기준쿠폰사용일
                , a.isfirstord      -- 구매확정조건첫구매확정여부
                , a.isordtotcate    -- 전체카테고리여부
                , a.ordgdrangetype  -- 전체상품범위
                , a.isnowissue      -- 즉시발급여부
                , a.isautopay       -- 즉시발급여부
                , a.ismemtype		-- 특정유형대상여부
                , a.istotcate 
                , a.goodsrangetype 
                , b.cpnusestday
                , b.cpnuseedday
            FROM t_comcoupon a
            INNER JOIN t_comcoupon_info b 
            ON a.comcpnidx = b.comcpnidx 
            WHERE a.siteid = #{siteid}
            AND a.istrash = 'F'
            AND a.ismemtype = 'T'
            AND a.isautopay = 'F'
            AND a.comcpntype = 'CCT001'
            AND a.cpnissuetype IN ('CIT001', 'CIT004')
            AND date_format(sysdate(), '%Y%m%d%H%i') BETWEEN b.cpnusestday AND b.cpnuseedday
            AND a.muappchtype like concat('%', #{platform}, '%') -- 다중적용채널
            AND b.CPNISSUEST IN ('CIS002','CIS004') -- 발급중
        ), allcoupon AS ( /* 전체카테고리 쿠폰, 전체상품 쿠폰 */
            SELECT comcpnidx
            FROM coupon
            WHERE istotcate = 'T'
            AND goodsrangetype = 'GGT001'
        ), incatecoupon AS ( /* 추가카테고리 쿠폰 */
            SELECT a.comcpnidx, b.cateidx
            FROM coupon a
            INNER JOIN t_comcoupon_cate b 
            ON a.comcpnidx = b.comcpnidx
            AND b.isadd = 'T'
            WHERE a.istotcate = 'F'
        ), ingoodscoupon AS ( /* 추가상품 쿠폰 */
            SELECT a.comcpnidx, b.goodsno, b.optioncode
            FROM coupon a
            INNER JOIN t_comcoupon_goods b 
            ON a.comcpnidx = b.comcpnidx
            WHERE a.goodsrangetype = 'GGT002'
        ), outcatecoupon AS ( /* 제외카테고리 쿠폰 */
            SELECT a.comcpnidx, b.cateidx
            FROM coupon a
            INNER JOIN t_comcoupon_cate b 
            ON a.comcpnidx = b.comcpnidx
            AND b.isadd = 'F'
            WHERE a.istotcate = 'F'
        ), outgoodscoupon AS ( /* 제외상품 쿠폰 */
            SELECT a.comcpnidx, b.goodsno, b.optioncode
            FROM coupon a
            INNER JOIN t_comcoupon_goods b 
            ON a.comcpnidx = b.comcpnidx
            WHERE a.goodsrangetype = 'GGT003'
        ), goods AS (
            SELECT a.goodsno, a.optioncode, b.cateidx
            FROM t_goods_option_detail a
            LEFT JOIN t_goods_category b
            ON a.goodsno = b.goodsno
            WHERE a.goodsno = #{goodsno}
        )
        SELECT 
              count(*)
        FROM (
            SELECT distinct
                  tt2.*
            FROM (
                /* 전체 적용쿠폰 */
                SELECT b.goodsno, b.optioncode, b.cateidx, a.comcpnidx
                FROM allcoupon a
                INNER JOIN goods b 
                UNION ALL
                /* 카페고리포함 적용쿠폰 */
                SELECT a.goodsno, a.optioncode, a.cateidx, b.comcpnidx
                FROM goods a
                INNER JOIN (
                    WITH RECURSIVE incate AS (
                        SELECT comcpnidx, cateidx
                        FROM incatecoupon
                        UNION ALL
                        SELECT t2.comcpnidx, idx
                        FROM t_category t1, incate t2
                        WHERE t1.parent = t2.cateidx
                    )
                    SELECT comcpnidx, cateidx
                    FROM incate
                ) b
                ON a.cateidx = b.cateidx
                UNION ALL
                /* 카페고리제회 적용쿠폰 */
                SELECT a.goodsno, a.optioncode, a.cateidx, b.comcpnidx
                FROM goods a
                INNER JOIN (
                    WITH RECURSIVE outcate AS (
                        SELECT comcpnidx, cateidx
                        FROM outcatecoupon
                        UNION ALL
                        SELECT t2.comcpnidx, idx
                        FROM t_category t1, outcate t2
                        WHERE t1.parent = t2.cateidx
                    )
                    SELECT comcpnidx, cateidx
                    FROM outcate
                ) b
                ON a.cateidx = b.cateidx
                WHERE b.cateidx IS NULL
                UNION ALL
                /* 특정상품포함 적용쿠폰 */
                SELECT a.goodsno, a.optioncode, a.cateidx, b.comcpnidx
                FROM goods a
                INNER JOIN ingoodscoupon b
                ON a.goodsno = b.goodsno
                AND a.optioncode = b.optioncode
                UNION ALL
                /* 특정상품제외 적용쿠폰 */
                SELECT a.goodsno, a.optioncode, a.cateidx, b.comcpnidx
                FROM goods a
                INNER JOIN outgoodscoupon b
                ON a.goodsno = b.goodsno
                AND a.optioncode = b.optioncode
            ) tt1
            INNER JOIN coupon tt2
            ON tt1.comcpnidx = tt2.comcpnidx
        ) ttt
	</select>
	
	<select id="selectCouponERPData" parameterType="somap" resultType="somap">
		SELECT
			A.COMCPNIDX, COMCPNNO, COMCPNTYPE, CPNISSUETYPE, ISTRASH, CPNDESC, ISMEMTYPE, MUMEMBERTYPE
			 ,MUMEMLVTYPE, ISRCVLIMIT, MUMEMRCVTYPE, ISTOTCATE, GOODSRANGETYPE, PARTRATIO, CPNUSETYPE
			 ,ISSUEDAYCNT, MUAPPCHTYPE, ISORDERLIMIT, ORLIMITAMT, ISPERCENT, DISPRICE, DISPERCENT
			 ,MAXDISAMT, ISRVMARGIN, ISNOWISSUE, ISAUTOPAY, ISCNTLIMT, CPNLIMTCNT, ISDUPPERSON
			 ,DUPCNT, MUCPNDUPTYPE, ISBIRTHTHEDAY, BIRTHBFDAYCNT, ISEVERYDAY, EVERYDAYLOOP, EVERYMONTHLOOP
			 ,EVERYHHMM, ISFIRSTORD, ORDGDRANGETYPE, ISORDTOTCATE, EVRCPNUSESTDAY, EVRCPNUSEEDDAY
			 , B.CPNINFOIDX, B.CPNNAME, B.CPNISSUEST, B.CPNISSUEDAY, B.CPNUSESTDAY, B.CPNUSEEDDAY, B.CPNDELTYPE
			 , C.CPNISIDX, C.CPNISTYPE, C.ISNOWSTOP, C.ISNOWRESTART, C.CPNSTOPSTDAY, C.CPNSTOPEDDAY, C.CPNRESTARTDAY
			 , D.IFLOGIDX, D.AUD_TYPE_CD
		FROM T_COMCOUPON A INNER JOIN T_COMCOUPON_INFO B ON A.COMCPNIDX = B.COMCPNIDX AND (IF(A.CPNISSUETYPE = 'CIT004', A.CPNISSUEDAY = B.CPNISSUEDAY, TRUE))
						   LEFT OUTER JOIN T_COMCOUPON_ISSUE C ON C.CPNISIDX  = (
			SELECT MAX(CPNISIDX) FROM T_COMCOUPON_ISSUE WHERE CPNINFOIDX = B.CPNINFOIDX GROUP BY CPNINFOIDX
		) INNER JOIN (
			SELECT
				ORGNO, GROUP_CONCAT(IFLOGIDX) AS IFLOGIDX, MIN(REGDATE) AS REGDATE
				 ,AUDDIV AS AUD_TYPE_CD
			FROM T_IFLOG A
			WHERE IFTYPE = 'IFT007'
			  AND IFDATE IS NULL
			GROUP BY ORGNO, AUDDIV
		)D ON A.COMCPNIDX = D.ORGNO
		WHERE SITEID = #{siteid}
		ORDER BY D.REGDATE
	</select>

	<select id="selectCouponDashBoard" parameterType="somap" resultType="somap">
		SELECT
			FORMAT(IFNULL(SUM(IF(B.CPNISSUEST = 'CIS001', 1, 0)), 0), 0) AS BEFOREISSUE
			 , FORMAT(IFNULL(SUM(IF(B.CPNISSUEST = 'CIS002', 1, 0)), 0), 0) AS ISSUE
			 , FORMAT(IFNULL(SUM(IF(B.CPNISSUEST = 'CIS002' AND CURRENT_TIMESTAMP BETWEEN DATE_ADD(STR_TO_DATE(B.CPNUSEEDDAY, '%Y%m%d%H%i'), INTERVAL -7 DAY) AND STR_TO_DATE(B.CPNUSEEDDAY, '%Y%m%d%H%i'), 1, 0)), 0), 0) AS EXPIREISSUE
		FROM T_COMCOUPON A INNER JOIN T_COMCOUPON_INFO B ON A.COMCPNIDX = B.COMCPNIDX
		WHERE SITEID = #{siteid}
	    AND A.ISTRASH = 'F'
	</select>
	
	<select id="selectLifeCoupon" parameterType="somap" resultType="somap">
	    SELECT /*CouponMapper.xml - selectLifeCoupon::평생회원 쿠폰 목록 조회*/ 
	          a.COMCPNIDX
	        , b.CPNINFOIDX
	        , b.CPNUSESTDAY
	        , b.CPNUSEEDDAY
			, b.cpnname
            , ISPERCENT
            , DISPRICE
            , DISPERCENT
        FROM t_comcoupon a
        inner join t_comcoupon_info b on a.COMCPNIDX = b.COMCPNIDX
        where a.comcpnno = #{comcpnno}
        and a.ISTRASH = 'F'
	</select>
	
	<!-- 쿠폰 사용여부 수정 -->
	<update id="updateCouponUse" parameterType="somap">
		UPDATE T_COMCOUPON SET	/* CouponMapper.xml - updateCouponUse 쿠폰 사용여부 수정 */
			  ISTRASH = #{istrash}
			, MODUSERID = #{authuserid}
			, MODDATE = NOW()
		WHERE SITEID = #{siteid}
		AND COMCPNIDX = #{comcpnidx}
	</update>
</mapper>
